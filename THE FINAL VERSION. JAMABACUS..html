<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <!-- Import DM Sans font from Google Fonts -->
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans&display=swap" rel="stylesheet" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>UCMAS Hoxton Park</title> <!-- Changed title -->
  <style>
    /* Global Styles */
    body {
      font-family: 'DM Sans', sans-serif;
      background-color: #f9f9f9;
      margin: 0;
      padding: 10px;
      text-align: center;
      overflow-x: hidden; /* Prevent horizontal scroll due to animations */
    }
    /* Header */
    header {
      margin-bottom: 10px;
    }
    header h1 {
      font-size: 1.75rem;
      margin: 0;
      color: #333;
    }
    header p {
      font-size: 0.8rem;
      margin: 4px 0 0;
      color: #666;
    }
    #loggedInStatus {
        font-size: 0.9rem;
        color: #555;
        margin-top: 5px;
        min-height: 18px; /* Maintain space even if empty */
    }

    /* General Container Styling */
    .container, #loginPage, #rankingPage, #parentView, #accountsPage { /* Added #accountsPage */
      max-width: 1200px;
      margin: 0 auto;
      background-color: #fff;
      border-radius: 16px; /* More rounded */
      padding: 20px;
      box-shadow: 0 8px 20px rgba(0, 0, 0, 0.1); /* More prominent shadow */
      text-align: left;
      transition: box-shadow 0.3s ease;
    }
    .container:hover, #loginPage:hover, #rankingPage:hover, #parentView:hover, #accountsPage:hover { /* Added #accountsPage */
      box-shadow: 0 10px 25px rgba(0, 0, 0, 0.2); /* Slightly more intense hover shadow */
    }

    /* Lesson Save Form */
    #lessonForm {
      margin-bottom: 20px;
      text-align: center;
      display: flex; /* Use flexbox for button layout */
      align-items: center;
      justify-content: center;
      gap: 10px; /* Space between elements */
      position: relative; /* For menu positioning */
    }
    #lessonForm label {
      font-size: 0.9rem;
      margin-right: 5px;
      color: #555;
    }
    #lessonForm input[type="date"] {
      padding: 8px 12px; /* Larger padding */
      font-size: 0.95rem; /* Slightly larger font */
      border: 1px solid #ccc;
      border-radius: 8px; /* More rounded */
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05); /* Inner shadow for depth */
    }
    #lessonForm input[type="date"]:focus {
      border-color: #4caf50;
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2); /* Green glow on focus */
    }
    #lessonForm button {
      padding: 8px 16px; /* Larger buttons */
      font-size: 0.95rem; /* Slightly larger font */
      border: none;
      border-radius: 8px; /* More rounded */
      background-color: #4caf50;
      color: white;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1); /* Subtle button shadow */
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    #lessonForm button:hover {
      background-color: #43a047;
      transform: translateY(-2px) scale(1.02); /* Lift and grow slightly */
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #lessonForm button:active {
        transform: translateY(0); /* Press down effect */
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* Menu Icon Button */
    #menuButton {
        background-color: #607d8b; /* Blue-grey for menu icon */
        font-size: 1.5rem; /* Larger icon */
        line-height: 1; /* Align vertically */
        padding: 6px 12px; /* Adjusted padding */
        border-radius: 8px;
    }
    #menuButton:hover {
        background-color: #546e7a;
    }

    /* Dropdown Menu Container */
    #menuButtons {
        position: absolute;
        top: 100%; /* Position below the menu button */
        right: 0; /* Align to the right of the form */
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        padding: 10px;
        display: flex;
        flex-direction: column;
        gap: 8px; /* Space between menu items */
        z-index: 10; /* Ensure it's above other content */
        min-width: 160px; /* Minimum width for readability */
        transform-origin: top right;
        opacity: 0;
        transform: scale(0.9);
        transition: opacity 0.3s ease-out, transform 0.3s ease-out;
        pointer-events: none; /* Disable interaction when hidden */
    }
    #menuButtons.show {
        opacity: 1;
        transform: scale(1);
        pointer-events: auto; /* Enable interaction when shown */
    }
    #menuButtons button {
        width: 100%; /* Full width within the dropdown */
        padding: 10px 15px; /* Larger padding for menu items */
        font-size: 0.9rem;
        justify-content: flex-start; /* Align text to left */
        background-color: #f0f0f0; /* Lighter background for menu items */
        color: #333;
        box-shadow: none; /* Remove individual button shadow */
        transition: background-color 0.2s ease, transform 0.2s ease;
    }
    #menuButtons button:hover {
        background-color: #e0e0e0; /* Darker hover */
        transform: translateX(3px); /* Slide slightly on hover */
        box-shadow: none;
    }


    /* Table Styles */
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 8px;
      table-layout: fixed;
      border-radius: 12px;
      overflow: hidden; /* Ensures rounded corners on inner elements */
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); /* Subtle shadow for table */
    }
    th, td {
      padding: 10px 8px; /* Increased padding */
      text-align: center;
      border: 1px solid #eee; /* Lighter borders */
      vertical-align: middle;
      font-size: 0.85rem;
      transition: background-color 0.2s ease;
    }
    th {
      background-color: #4caf50;
      color: white;
      font-weight: bold;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 2px solid #388e3c;
    }
    tbody tr:nth-child(even) {
      background-color: #fcfcfc;
    }
    tbody tr:nth-child(odd) {
      background-color: #ffffff;
    }
    tbody tr:hover {
        background-color: #e8f5e9; /* Light green hover effect for rows */
    }

    /* Make Student Name column interactive */
    #pointsTable tbody tr td:first-child {
      cursor: pointer;
      transition: transform 0.2s ease, font-size 0.2s ease; /* Added font-size transition */
      font-weight: bold;
      color: #444;
    }
    #pointsTable tbody tr td:first-child:hover {
      transform: scale(1.05);
      font-size: 0.95rem; /* Increase font size on hover */
    }
    /* Custom Input & Checkbox Styles */
    input[type="text"].custom-text,
    input[type="number"].custom-input,
    input[type="password"].custom-input { /* Added password input */
      border: 1px solid #ccc;
      border-radius: 6px; /* More rounded */
      padding: 6px 8px; /* More padding */
      transition: border-color 0.2s ease, box-shadow 0.2s ease;
      box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    input[type="text"].custom-text:focus,
    input[type="number"].custom-input:focus,
    input[type="password"].custom-input:focus { /* Added password input */
      border-color: #4caf50;
      outline: none;
      box-shadow: 0 0 0 3px rgba(76, 175, 80, 0.2);
    }
    input[type="checkbox"].custom-checkbox {
      -webkit-appearance: none;
      -moz-appearance: none;
      appearance: none;
      width: 28px;
      height: 28px;
      border: 2px solid #4caf50;
      border-radius: 6px; /* Slightly rounded checkbox */
      background: #fff;
      cursor: pointer;
      position: relative;
      transition: background 0.2s ease, transform 0.2s ease, border-color 0.2s ease;
    }
    input[type="checkbox"].custom-checkbox:checked {
      background: #4caf50;
      border-color: #4caf50;
    }
    input[type="checkbox"].custom-checkbox:checked::after {
      content: '✓';
      color: #fff;
      font-size: 16px;
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%);
    }
    input[type="checkbox"].custom-checkbox:hover {
      transform: scale(1.1);
      border-color: #43a047;
    }
    input[type="checkbox"].custom-checkbox:disabled {
        border-color: #ccc;
        background-color: #e0e0e0;
        cursor: not-allowed;
        opacity: 0.7;
    }
    input[type="checkbox"].custom-checkbox:disabled:checked {
        background-color: #9e9e9e; /* Darker grey when disabled and checked */
    }

    /* Per-Cell Customization Controls */
    .cell-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 4px; /* More space */
    }
    .cell-customizer {
      display: flex;
      align-items: center;
      gap: 4px; /* More space */
      margin-top: 2px;
    }
    .cell-customizer button {
      padding: 4px 8px; /* Larger touch targets */
      font-size: 0.8rem;
      cursor: pointer;
      border: none;
      background-color: #e0e0e0;
      border-radius: 6px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .cell-customizer button:hover {
      background-color: #d5d5d5;
      transform: translateY(-1px) scale(1.02);
      box-shadow: 0 2px 4px rgba(0,0,0,0.15);
    }
    .cell-value-input {
      width: 40px; /* Slightly wider */
      font-size: 0.85rem;
      text-align: center;
      padding: 4px;
    }
    /* NUMBER ACTIVITY Column Redesign */
    .numact-cell {
      display: flex;
      gap: 12px; /* More space */
      justify-content: center;
      align-items: center;
      min-width: 320px;
    }
    .numact-text {
      width: 150px; /* Wider text input */
      font-size: 0.85rem;
      padding: 6px;
    }
    .numact-number-container {
      display: flex;
      flex-direction: column;
      gap: 4px;
      align-items: center;
    }
    /* Global Update Panel */
    #globalUpdateContainer { 
        display: flex;
        justify-content: space-around; 
        gap: 20px; 
        margin-top: 25px; /* More space */
        flex-wrap: wrap; 
        align-items: flex-start; /* Align tops of panels */
    }
    #globalUpdatePanel, #studentStatusPanel { 
      padding: 20px; /* More padding */
      border: 1px solid #ddd;
      border-radius: 12px;
      background-color: #fefefe;
      text-align: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08); /* Consistent shadow */
      transition: box-shadow 0.3s ease;
      flex: 1; 
      min-width: 320px; 
    }
    #globalUpdatePanel:hover, #studentStatusPanel:hover {
        box-shadow: 0 6px 15px rgba(0,0,0,0.12); /* Subtle hover effect */
    }

    #globalUpdatePanel h3, #studentStatusPanel h3 { 
      margin-top: 0;
      font-size: 1.2rem; /* Larger heading */
      color: #444;
      margin-bottom: 15px;
    }
    .global-control, .student-status-item {
      margin: 8px 0; /* More vertical space */
      display: flex;
      align-items: center;
      gap: 10px; /* More space */
      justify-content: center;
    }
    .global-control label, .student-status-item span {
      flex-grow: 1; /* Allow labels to take available space */
      text-align: right;
      font-size: 0.9rem;
      color: #666;
    }
    .global-control input {
      width: 50px; /* Wider input */
      font-size: 0.9rem;
      padding: 6px;
    }
    .global-control button, .student-status-item button {
      padding: 6px 12px; /* Larger buttons */
      font-size: 0.85rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .student-status-item {
        justify-content: space-between; /* Push name and button apart */
        padding: 5px 0;
        border-bottom: 1px dashed #eee; /* Light dashed separator */
    }
    .student-status-item:last-child {
        border-bottom: none;
    }
    .student-status-item span {
        text-align: left; /* Align student names left */
        font-weight: normal;
        color: #333;
    }

    /* Styles for absent rows */
    .absent-row {
        opacity: 0.5; 
        pointer-events: none; 
        background-color: #e8e8e8 !important; /* Consistent grey background */
        color: #999; /* Faded text color */
        transition: opacity 0.3s ease, background-color 0.3s ease;
    }
    .absent-row td {
        border-color: #e0e0e0; /* Faded borders for absent rows */
    }
    /* Specific override for the Absent button in the status panel so it remains clickable */
    #studentStatusPanel .student-status-item button {
        pointer-events: auto; 
    }
    /* Style for absent button when student is absent */
    .student-status-item button.absent {
        background-color: #e53935; /* Red for Absent */
    }
    .student-status-item button.absent:hover {
        background-color: #d32f2f;
    }

    /* Lesson Tabs */
    #lessonTabs {
      margin-top: 30px; /* More space */
      text-align: center;
      display: flex;
      flex-wrap: wrap;
      justify-content: center;
      gap: 10px; /* Space between tabs */
    }
    .lesson-tab {
      padding: 8px 15px; /* Larger tabs */
      border: 1px solid #a5d6a7; /* Lighter green border */
      border-radius: 20px; /* Very rounded pill shape */
      cursor: pointer;
      font-size: 0.85rem;
      color: #4caf50;
      background-color: #f1f8e9; /* Very light green background */
      box-shadow: 0 1px 3px rgba(0,0,0,0.08);
      transition: background-color 0.2s ease, transform 0.2s ease, color 0.2s ease, box-shadow 0.2s ease;
    }
    .lesson-tab:hover {
      transform: translateY(-2px);
      background-color: #dcedc8; /* Slightly darker light green hover */
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    .lesson-tab.active {
      background-color: #4caf50;
      color: white;
      box-shadow: 0 2px 8px rgba(0,0,0,0.3); /* Stronger shadow for active */
      transform: scale(1.02); /* Slight scale for active */
    }
    /* Clear All Saves Button */
    #clearSaves {
      margin-top: 20px;
      padding: 10px 20px; /* Larger button */
      font-size: 1rem;
      background-color: #e53935;
      color: white;
      border: none;
      border-radius: 8px;
      cursor: pointer;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    #clearSaves:hover {
      background-color: #d32f2f;
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #clearSaves:active {
        transform: translateY(0);
        box-shadow: 0 1px 3px rgba(0,0,0,0.2);
    }

    /* --- Report & Message Modal Styles --- */
    #reportModal, #messageModal, #confirmModal, #multiInputConfirmModal { /* Added multiInputConfirmModal */
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.6); /* Slightly darker overlay */
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      opacity: 0;
      transition: opacity 0.3s ease-out;
    }
    #reportModal.show, #messageModal.show, #confirmModal.show, #multiInputConfirmModal.show { /* Added multiInputConfirmModal */
      display: flex;
      opacity: 1;
    }
    .modal-content {
      background: #fff;
      padding: 30px; /* More padding */
      border-radius: 12px; /* More rounded */
      max-width: 650px; /* Slightly wider */
      width: 90%;
      max-height: 90%;
      overflow-y: auto;
      position: relative;
      box-shadow: 0 10px 30px rgba(0, 0, 0, 0.2); /* Stronger modal shadow */
      transform: translateY(20px);
      opacity: 0;
      transition: transform 0.3s ease-out, opacity 0.3s ease-out;
    }
    #reportModal.show .modal-content, #messageModal.show .modal-content, #confirmModal.show .modal-content, #multiInputConfirmModal.show .modal-content { /* Added multiInputConfirmModal */
        transform: translateY(0);
        opacity: 1;
    }
    .close-btn {
      position: absolute;
      top: 15px;
      right: 15px;
      background: #e53935;
      border: none;
      color: white;
      border-radius: 50%;
      width: 35px; /* Larger close button */
      height: 35px;
      font-size: 18px;
      cursor: pointer;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2);
      transition: background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    .close-btn:hover {
      background: #d32f2f;
      transform: scale(1.1);
      box-shadow: 0 2px 5px rgba(0,0,0,0.3);
    }
    .report-table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 15px; /* More space */
      table-layout: fixed;
      border-radius: 8px; /* Slight rounding for tables within modals */
      overflow: hidden;
    }
    .report-table th, .report-table td {
      border: 1px solid #e0e0e0; /* Lighter borders */
      padding: 10px; /* More padding */
      text-align: left;
      font-size: 0.88rem;
    }
    .report-table th {
      background-color: #f5f5f5;
      font-weight: bold;
    }
    .report-table tbody tr:nth-child(odd) {
        background-color: #ffffff;
    }
    .report-table tbody tr:nth-child(even) {
        background-color: #fcfcfc;
    }
    .modal-buttons {
      margin-top: 25px; /* More space */
    }
    .modal-buttons button {
      padding: 10px 20px; /* Larger buttons */
      margin: 0 8px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    /* Report specific controls */
    .report-actions {
        margin-top: 20px;
        display: flex;
        flex-direction: column; /* Changed to column for clarity */
        justify-content: center;
        gap: 15px;
        flex-wrap: wrap;
    }
    .report-actions button {
        padding: 8px 15px;
        font-size: 0.9rem;
        border-radius: 8px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        transition: transform 0.2s ease, box-shadow 0.2s ease;
    }
    .report-actions button:hover {
        transform: translateY(-1px);
        box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    }
    .report-actions button.edit-btn {
        background-color: #2196f3; /* Blue */
        color: white;
    }
    .report-actions button.edit-btn:hover {
        background-color: #1976d2;
    }
    .report-actions button.delete-btn {
        background-color: #f44336; /* Red */
        color: white;
    }
    .report-actions button.delete-btn:hover {
        background-color: #d32f2f;
    }
    .report-actions .student-code-display { /* New style for student code */
        display: flex;
        align-items: center;
        justify-content: center;
        gap: 10px;
        margin-bottom: 10px;
        font-size: 1rem;
        font-weight: bold;
        color: #444;
        background-color: #e0f2f1; /* Light teal background */
        padding: 10px 15px;
        border-radius: 8px;
        border: 1px dashed #009688;
    }
    .report-actions .copy-button {
        padding: 6px 12px;
        background-color: #4CAF50;
        color: white;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-size: 0.8rem;
        transition: background-color 0.2s;
    }
    .report-actions .copy-button:hover {
        background-color: #43A047;
    }


    /* Main content and Page Toggle */
    #mainContent {
        display: block; /* Managed by JS, starts hidden */
        opacity: 1;
        transition: opacity 0.5s ease-out;
    }
    .hidden-page {
        display: none !important; /* Force hide */
        opacity: 0;
        pointer-events: none; /* Disable interaction when hidden */
        height: 0; /* Collapse height when hidden */
        overflow: hidden; /* Hide overflow content */
    }

    /* New/Updated Ranking Page Styles */
    #rankingPage {
        display: none; /* Initially hidden */
        padding: 30px; 
        border-radius: 16px; 
        background-color: #ffffff;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15); 
        max-width: 800px; 
        margin: 30px auto; 
        text-align: center;
        animation: fadeIn 0.5s ease-out; 
        max-height: 80vh; /* Limit height to 80% of viewport height */
        overflow-y: auto; /* Enable scrolling within the ranking page */
    }
    #rankingPage h2 {
        font-size: 1.8rem; 
        color: #333;
        margin-bottom: 25px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.05); 
    }
    #rankingPage .ranking-controls {
        margin-bottom: 30px; 
        display: flex;
        justify-content: center;
        gap: 15px; 
        flex-wrap: wrap;
    }
    #rankingPage .ranking-controls button {
        padding: 10px 20px; 
        font-size: 1rem; 
        border: none;
        border-radius: 8px; 
        background-color: #4caf50;
        color: white;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1); 
        transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    #rankingPage .ranking-controls button:hover {
        background-color: #43a047;
        transform: translateY(-2px) scale(1.02); 
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #rankingPage .ranking-controls button.back-button {
        background-color: #607d8b; /* Blue-grey for back button */
    }
    #rankingPage .ranking-controls button.back-button:hover {
        background-color: #546e7a;
    }
    #rankingPage #rankingResults {
        text-align: left;
        background-color: #fdfdfd; 
        padding: 20px;
        border-radius: 12px;
        box-shadow: inset 0 1px 5px rgba(0,0,0,0.05); 
    }
    #rankingPage #rankingResults h3 {
        margin-top: 0;
        color: #555;
        font-size: 1.3rem;
        border-bottom: 1px solid #eee;
        padding-bottom: 10px;
        margin-bottom: 20px;
    }
    .ranking-table {
        border: none; 
    }
    .ranking-table th {
        background-color: #e0f2f1; /* Light teal for ranking table headers */
        color: #333;
        font-weight: bold;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        border-bottom: 2px solid #b2dfdb; 
    }
    .ranking-table td {
        border-bottom: 1px solid #f0f0f0; 
        padding: 10px 8px; 
        font-size: 0.9rem;
    }
    .ranking-table tbody tr:last-child td {
        border-bottom: none; 
    }
    .ranking-table tbody tr:hover {
        background-color: #e8f5e9; 
    }

    /* Login Page Styles */
    #loginPage {
        display: flex; /* Starts hidden */
        flex-direction: column;
        align-items: center;
        justify-content: center;
        min-height: 400px; /* Ensure it's not too small */
        max-width: 500px; /* Smaller width for login */
        padding: 40px;
        margin-top: 50px;
        animation: fadeIn 0.5s ease-out;
    }
    #loginPage h2 {
        font-size: 2rem;
        color: #333;
        margin-bottom: 30px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
    }
    #loginPage .form-group {
        width: 100%;
        margin-bottom: 15px;
        text-align: left;
    }
    #loginPage .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.95rem;
        color: #555;
    }
    #loginPage .form-group input {
        width: calc(100% - 16px); /* Account for padding */
        padding: 10px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    #loginPage .form-actions {
        margin-top: 25px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        width: 100%;
    }
    #loginPage .form-actions button {
        width: 100%;
        padding: 12px 20px;
        font-size: 1.1rem;
        background-color: #4caf50;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 3px 8px rgba(0,0,0,0.15);
        transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    #loginPage .form-actions button:hover {
        background-color: #43a047;
        transform: translateY(-2px);
        box-shadow: 0 5px 12px rgba(0,0,0,0.2);
    }
    #loginPage .form-actions button.secondary-btn {
        background-color: #2196f3; /* Blue for secondary actions */
    }
    #loginPage .form-actions button.secondary-btn:hover {
        background-color: #1976d2;
    }
    #loginPage .form-actions button.back-button {
        background-color: #9e9e9e;
    }
    #loginPage .form-actions button.back-button:hover {
        background-color: #757575;
    }

    #loginForm, #registerForm {
        width: 100%;
        display: none; /* Controlled by JS */
        animation: fadeIn 0.5s ease-out;
    }
    #loginForm.show, #registerForm.show {
        display: flex;
        flex-direction: column;
        align-items: center;
    }
    #loginPage p.warning-message, #loginPage p.info-message, #loginPage p.error-message {
        font-size: 0.9rem;
        margin-top: 10px;
        padding: 8px 12px;
        border-radius: 8px;
        background-color: #fffde7; /* Light yellow for general messages */
        color: #827717; /* Dark yellow text */
        border: 1px solid #ffeb3b;
    }
    #loginPage p.warning-message {
        background-color: #ffe0b2; /* Light orange for warnings */
        color: #e65100; /* Dark orange text */
        border: 1px solid #ffcc80;
    }
    #loginPage p.info-message {
        background-color: #e8f5e9; /* Light green for info */
        color: #2e7d32; /* Dark green text */
        border-color: #a5d6a7;
    }
    #loginPage p.error-message {
        background-color: #ffebee; /* Light red for errors */
        color: #c62828; /* Dark red text */
        border-color: #ef9a9a;
    }
    /* Parent View Styles */
    #parentView {
        display: none; /* Managed by JS */
        padding: 50px;
        text-align: center;
        animation: fadeIn 0.5s ease-out;
        max-width: 600px;
        margin-top: 50px;
    }
    #parentView h2 {
        font-size: 2rem;
        color: #3f51b5; /* A pleasant blue */
        margin-bottom: 20px;
    }
    #parentView p {
        font-size: 1.1rem;
        color: #666;
        line-height: 1.6;
    }
    #parentView .parent-content-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    #parentView .parent-content-section:last-of-type {
        border-bottom: none;
        margin-bottom: 0;
        padding-bottom: 0;
    }
    #parentView .form-group {
        width: 100%;
        margin-bottom: 15px;
        text-align: center; /* Center align form elements */
    }
    #parentView .form-group label {
        display: block;
        margin-bottom: 8px;
        font-size: 1rem;
        color: #555;
    }
    #parentView .form-group input {
        width: calc(80% - 20px); /* Smaller input width */
        max-width: 300px;
        padding: 10px;
        font-size: 1rem;
        border: 1px solid #ccc;
        border-radius: 8px;
        text-align: center; /* Center text in input */
    }
    #parentView .form-actions button {
        width: auto; /* Adjust button width */
        min-width: 150px;
        padding: 10px 20px;
        font-size: 1rem;
        margin-left: 10px; /* Space between buttons */
        margin-right: 10px;
        background-color: #2196f3; /* Blue for parent actions */
    }
    #parentView .form-actions button:hover {
        background-color: #1976d2;
    }
    #parentView .linked-student-info {
        background-color: #e8f5e9;
        border: 1px solid #a5d6a7;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    #parentView .linked-student-info p {
        font-size: 1.2rem;
        font-weight: bold;
        color: #2e7d32;
        margin-bottom: 15px;
    }
    #parentView .confirm-student-prompt {
        background-color: #fff3e0;
        border: 1px solid #ffcc80;
        border-radius: 12px;
        padding: 20px;
        margin-top: 20px;
    }
    #parentView .confirm-student-prompt p {
        font-size: 1.1rem;
        color: #e65100;
        margin-bottom: 15px;
    }
    #parentView .confirm-student-prompt button {
        background-color: #4CAF50;
        margin: 0 10px;
    }
    #parentView .confirm-student-prompt button.no-btn {
        background-color: #f44336;
    }

    /* Animation for fade-in */
    @keyframes fadeIn {
        from { opacity: 0; transform: translateY(20px); }
        to { opacity: 1; transform: translateY(0); }
    }
    /* Animation for fade-out (if needed for menu, etc.) */
    @keyframes fadeOut {
        from { opacity: 1; transform: translateY(0); }
        to { opacity: 0; transform: translateY(20px); }
    }

    /* Multi-input confirmation modal specific styles */
    #multiInputConfirmModal .form-group {
        margin-bottom: 15px;
    }
    #multiInputConfirmModal .form-group label {
        display: block;
        margin-bottom: 5px;
        font-size: 0.9rem;
        color: #555;
        text-align: left;
    }
    #multiInputConfirmModal .form-group input {
        width: calc(100% - 20px); /* Adjust for padding */
        padding: 10px;
        border: 1px solid #ccc;
        border-radius: 8px;
        box-shadow: inset 0 1px 3px rgba(0,0,0,0.05);
    }
    #multiInputConfirmModal .modal-buttons {
        display: flex;
        justify-content: center;
        gap: 15px;
    }

    /* Accounts Page Specific Styles */
    #accountsPage {
        display: none; /* Initially hidden */
        padding: 30px;
        border-radius: 16px;
        background-color: #ffffff;
        box-shadow: 0 8px 20px rgba(0, 0, 0, 0.15);
        max-width: 600px; /* Smaller width for accounts page */
        margin: 30px auto;
        text-align: center;
        animation: fadeIn 0.5s ease-out;
    }
    #accountsPage h2 {
        font-size: 1.8rem;
        color: #333;
        margin-bottom: 25px;
        text-shadow: 1px 1px 2px rgba(0,0,0,0.05);
    }
    #accountsPage .profile-section {
        margin-bottom: 30px;
        padding-bottom: 20px;
        border-bottom: 1px solid #eee;
    }
    #accountsPage .profile-section img {
        width: 120px;
        height: 120px;
        border-radius: 50%;
        object-fit: cover;
        margin-bottom: 15px;
        border: 3px solid #4caf50;
        box-shadow: 0 4px 10px rgba(0,0,0,0.1);
    }
    #accountsPage .profile-section p {
        font-size: 1.1rem;
        color: #555;
        margin: 5px 0 15px;
    }
    #accountsPage .pfp-input-group {
        display: flex;
        justify-content: center;
        align-items: center;
        gap: 10px;
        flex-wrap: wrap;
        margin-bottom: 20px;
    }
    #accountsPage .pfp-input-group input {
        flex-grow: 1;
        max-width: 300px;
        padding: 8px 12px;
        border: 1px solid #ccc;
        border-radius: 8px;
    }
    #accountsPage .pfp-input-group button {
        padding: 8px 15px;
        background-color: #2196f3; /* Blue */
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        transition: background-color 0.2s ease;
    }
    #accountsPage .pfp-input-group button:hover {
        background-color: #1976d2;
    }
    #accountsPage .account-actions {
        display: flex;
        flex-direction: column;
        gap: 12px;
        margin-bottom: 30px;
    }
    #accountsPage .account-actions button {
        padding: 12px 20px;
        font-size: 1rem;
        border: none;
        border-radius: 8px;
        color: white;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    #accountsPage .account-actions button:hover {
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }
    #accountsPage .account-actions .change-pwd-btn {
        background-color: #4caf50;
    }
    #accountsPage .account-actions .change-pwd-btn:hover {
        background-color: #43a047;
    }
    #accountsPage .account-actions .delete-acc-btn {
        background-color: #f44336; /* Red */
    }
    #accountsPage .account-actions .delete-acc-btn:hover {
        background-color: #d32f2f;
    }
    #accountsPage .account-actions .logout-btn {
        background-color: #607d8b; /* Blue-grey */
    }
    #accountsPage .account-actions .logout-btn:hover {
        background-color: #546e7a;
    }
    #accountsPage .back-button {
        padding: 10px 20px;
        font-size: 1rem;
        background-color: #9e9e9e;
        color: white;
        border: none;
        border-radius: 8px;
        cursor: pointer;
        box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        transition: background-color 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
    }
    #accountsPage .back-button:hover {
        background-color: #757575;
        transform: translateY(-2px);
        box-shadow: 0 4px 8px rgba(0,0,0,0.2);
    }


    /* Responsive adjustments */
    @media (max-width: 768px) {
        #lessonForm {
            flex-wrap: wrap;
            justify-content: center;
            gap: 8px;
        }
        #lessonForm label, #lessonForm input[type="date"] {
            flex-basis: 100%;
            margin-right: 0;
        }
        #lessonForm button {
            flex-basis: auto;
            min-width: 100px;
        }
        #menuButtons {
            right: 5%; /* Adjust for better mobile positioning */
            left: auto;
            width: auto;
        }
        #globalUpdateContainer {
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }
        #globalUpdatePanel, #studentStatusPanel {
            min-width: unset;
            width: 100%;
        }
        .numact-cell {
            flex-direction: column;
            min-width: unset;
            width: 100%;
            gap: 8px;
        }
        .numact-text {
            width: calc(100% - 16px); /* Account for padding */
        }
        .ranking-table th, .ranking-table td {
            font-size: 0.8rem;
            padding: 8px 5px;
        }
        #loginPage, #parentView, #accountsPage {
            max-width: 90%;
            margin-top: 20px;
            padding: 25px;
        }
        #loginPage .form-group input {
            width: calc(100% - 20px); /* Adjust for mobile padding */
        }
        #multiInputConfirmModal .form-group input {
            width: calc(100% - 20px);
        }
        #accountsPage .pfp-input-group {
            flex-direction: column;
            gap: 8px;
        }
        #accountsPage .pfp-input-group input {
            width: calc(100% - 24px); /* Full width minus padding */
        }
        #accountsPage .pfp-input-group button {
            width: 100%;
        }
        #parentView .form-group input {
            width: calc(100% - 20px);
        }
    }
  </style>
</head>
<body>
  <!-- Header -->
  <header>
    <h1>UCMAS Hoxton Park</h1> <!-- Changed company name -->
    <p>UCMAS x Rohind ©</p>
    <div id="loggedInStatus"></div>
  </header>

  <!-- Login Page Section -->
  <div id="loginPage" class="container hidden-page">
    <h2>Welcome to UCMAS Hoxton Park</h2> <!-- Changed company name -->
    <p class="warning-message" style="margin-bottom: 20px;">
        **WARNING: This is a local demo. User accounts are stored directly in your browser and are NOT secure.**
    </p>
    <p id="authMessage" style="display: none;"></p> <!-- For displaying auth messages -->

    <!-- Login Form -->
    <form id="loginForm" class="show">
      <h3>Login</h3>
      <div class="form-group">
        <label for="loginUsername">Username:</label>
        <input type="text" id="loginUsername" class="custom-input" required />
      </div>
      <div class="form-group">
        <label for="loginPassword">Password:</label>
        <input type="password" id="loginPassword" class="custom-input" required />
      </div>
      <div class="form-actions">
        <button type="submit" onclick="handleLogin(event)">Login</button>
        <button type="button" class="secondary-btn" onclick="showRegisterForm()">New Account</button>
      </div>
    </form>

    <!-- Register Form -->
    <form id="registerForm">
      <h3>Create New Account</h3>
      <div class="form-group">
        <label for="registerUsername">Username:</label>
        <input type="text" id="registerUsername" class="custom-input" required />
      </div>
      <div class="form-group">
        <label for="registerPassword">Password:</label>
        <input type="password" id="registerPassword" class="custom-input" required />
      </div>
      <div class="form-actions">
        <button type="submit" onclick="handleRegister(event)">Register</button>
        <button type="button" class="back-button" onclick="showLoginForm()">Back to Login</button>
      </div>
    </form>
  </div>

  <!-- Parent View Section (Hidden until logged in as parent) -->
  <div id="parentView" class="container hidden-page">
    <h2>Parent View</h2>
    <div id="parentContent">
        <!-- Content for linked student or code input will go here -->
    </div>
    <div class="form-actions" style="margin-top: 30px;">
        <button type="button" class="back-button" onclick="showDeleteAccountModal()">Delete My Account</button> <!-- Moved here for parent view -->
        <button type="button" class="back-button" onclick="logout()">Logout</button>
    </div>
  </div>

  <!-- Main Content Section (Hidden until logged in as teacher) -->
  <div id="mainContent" class="container hidden-page">
    <!-- Lesson Save Form -->
    <form id="lessonForm">
      
      <label for="lessonDate">Lesson Date:</label>
      <input type="date" id="lessonDate" required />
      <button type="submit">Save Lesson</button>

      <!-- Menu Button -->
      <button type="button" id="menuButton" onclick="toggleMenu()">☰ Menu</button>

      <!-- Buttons hidden in the menu -->
      <div id="menuButtons">
          <button type="button" id="menuTuesdayClass" onclick="setTuesday()">Tuesday Class</button>
          <button type="button" id="menuSaturdayClass" onclick="setSaturday()">Saturday Class</button>
          <button type="button" id="menuAddStudent" onclick="addNewStudentRow()">Add Student</button>
          <button type="button" id="menuRanking" onclick="openRankingPage()">Ranking</button>
          <button type="button" id="menuAccounts" onclick="openAccountsPage()">Accounts</button> <!-- New button for Accounts Page -->
      </div>
    </form>
    
    <!-- Points Table -->
    <table id="pointsTable">
      <colgroup>
        <col style="width: 150px;">
        <col style="width: 100px;">
        <col style="width: 100px;">
        <col style="width: 100px;">
        <col style="width: 100px;">
        <col style="width: 400px;">
        <col style="width: 100px;">
        <col style="width: 100px;">
      </colgroup>
      <thead>
        <tr>
          <th>Student Name</th>
          <th>ARRIVAL</th>
          <th>HOMEWORK</th>
          <th>CLASSWORK</th>
          <th>LISTENING CALCULATION</th>
          <th>NUMBER ACTIVITY</th>
          <th>BEHAVIOUR</th>
          <th>Final Score</th>
        </tr>
      </thead>
      <tbody>
        <!-- Rows will be generated by JavaScript -->
      </tbody>
    </table>
    
    <!-- Global Update Container for both panels -->
    <div id="globalUpdateContainer">
        <!-- Global Update Panel -->
        <div id="globalUpdatePanel">
            <h3>Change for All Rows</h3>
            <div class="global-control">
                <label for="global-col-0">ARRIVAL:</label>
                <input type="number" id="global-col-0" value="5" />
                <button onclick="applyGlobalUpdate(0)">Apply</button>
            </div>
            <div class="global-control">
                <label for="global-col-1">HOMEWORK:</label>
                <input type="number" id="global-col-1" value="5" />
                <button onclick="applyGlobalUpdate(1)">Apply</button>
            </div>
            <div class="global-control">
                <label for="global-col-2">CLASSWORK:</label>
                <input type="number" id="global-col-2" value="5" />
                <button onclick="applyGlobalUpdate(2)">Apply</button>
            </div>
            <div class="global-control">
                <label for="global-col-3">LISTENING CALCULATION:</label>
                <input type="number" id="global-col-3" value="5" />
                <button onclick="applyGlobalUpdate(3)">Apply</button>
            </div>
            <div class="global-control">
                <label for="global-col-4">NUMBER ACTIVITY:</label>
                <input type="number" id="global-col-4" value="5" />
                <button onclick="applyGlobalUpdate(4)">Apply</button>
            </div>
            <div class="global-control">
                <label for="global-col-5">BEHAVIOUR:</label>
                <input type="number" id="global-col-5" value="-5" />
                <button onclick="applyGlobalUpdate(5)">Apply</button>
            </div>
        </div>

        <!-- Student Status Panel -->
        <div id="studentStatusPanel">
            <h3>Student Status</h3>
            <!-- Student status items will be dynamically generated here -->
        </div>
    </div>
    
    <!-- Lesson Tabs -->
    <div id="lessonTabs"></div>
    
    <!-- Clear All Saves Button -->
    <button id="clearSaves" onclick="clearAllSaves()">Clear All Saves</button>
  </div>
  
  <!-- Ranking Page Section (initially hidden) -->
  <div id="rankingPage" class="hidden-page">
    <h2>Student Rankings</h2>
    <div class="ranking-controls">
      <button onclick="displayRanking('Saturday')">Saturday Class Ranking</button>
      <button onclick="displayRanking('Tuesday')">Tuesday Class Ranking</button>
      <button class="back-button" onclick="closeRankingPage()">Back to Home</button>
    </div>
    <div id="rankingResults">
      <p>Select a class to view rankings.</p>
      <!-- Ranking table will be inserted here -->
    </div>
  </div>

  <!-- Accounts Page Section (newly added, initially hidden) -->
  <div id="accountsPage" class="container hidden-page">
      <h2>Your Account</h2>
      <div class="profile-section">
          <img id="profilePicture" src="https://via.placeholder.com/120/007bff/FFFFFF?text=UP" alt="Profile Picture">
          <p>Logged in as: <strong id="accountUsername"></strong> (<span id="accountRole"></span>)</p>
          <div class="pfp-input-group">
              <input type="text" id="pfpUrlInput" class="custom-input" placeholder="Paste image URL (e.g., from Gravatar)">
              <button onclick="saveProfilePicture()">Save Profile Picture</button>
          </div>
      </div>

      <div class="account-actions">
          <button class="change-pwd-btn" onclick="showChangePasswordModal()">Change Password</button>
          <button class="delete-acc-btn" onclick="showDeleteAccountModal()">Delete Account</button>
          <button class="logout-btn" onclick="logout()">Logout</button>
      </div>

      <button class="back-button" onclick="closeAccountsPage()">Back to Home</button>
  </div>


  <!-- Custom Modals (already existing, but kept here for completeness) -->
  <!-- Report Modal -->
  <div id="reportModal">
    <div class="modal-content" id="reportContent">
      <button class="close-btn" onclick="closeReport()">×</button>
      <!-- Report content is inserted dynamically -->
    </div>
  </div>

  <!-- Custom Message Modal -->
  <div id="messageModal">
    <div class="modal-content">
      <h2 id="messageTitle"></h2>
      <p id="messageText"></p>
      <div class="modal-buttons">
        <button class="message-ok" onclick="closeMessage()">OK</button>
      </div>
    </div>
  </div>

  <!-- Custom Confirmation Modal -->
  <div id="confirmModal">
    <div class="modal-content">
      <h2 id="confirmTitle"></h2>
      <p id="confirmText"></p>
      <div class="modal-buttons">
        <button class="confirm-yes" id="confirmYes">Yes</button>
        <button class="confirm-no" id="confirmNo">No</button>
      </div>
    </div>
  </div>

    <!-- Custom Confirmation Modal with Multiple Inputs -->
    <div id="multiInputConfirmModal">
        <div class="modal-content">
            <h2 id="multiInputConfirmTitle"></h2>
            <p id="multiInputConfirmText"></p>
            <div id="multiInputConfirmFields">
                <!-- Input fields will be dynamically added here -->
            </div>
            <div class="modal-buttons">
                <button class="confirm-yes" id="multiInputConfirmOk">OK</button>
                <button class="confirm-no" id="multiInputConfirmCancel">Cancel</button>
            </div>
        </div>
    </div>
  
  <script>
    // Global default points mapping (Indices: 0=ARRIVAL, 1=HOMEWORK, 2=CLASSWORK, 3=LISTENING CALCULATION, 4=NUMBER ACTIVITY, 5=BEHAVIOUR)
    let defaultPointsMapping = [5, 5, 5, 5, 5, -5];
    
    // Fixed student lists for different days
    const defaultStudents = ["Min", "Joanne", "Adhav", "Hevin"];
    const tuesdayStudents = ["Min", "Joanne", "Adhav", "Hevin", "Nila", "Tara", "Yaseen"];
    const saturdayStudents = ["Dhriti", "Indu", "Adhav", "Ashwika", "Marium", "Jesicca", "Anglea", "Marianna"];

    // This will hold the currently displayed student list and their absent status
    let currentStudentsData = []; // Array of { name: "StudentName", isAbsent: false, isNew: false, studentCode: "ABC123" }

    // Variable to store the currently logged-in user and their role
    let currentLoggedInUser = null; // { username: "...", role: "...", pfpUrl: "...", linkedStudent: {name: "...", teacher: "..."} }
    const defaultPfp = "https://placehold.co/120x120/007bff/FFFFFF?text=UP"; // Default PFP if none set

    // Temp storage for student linking confirmation
    let tempStudentCodeData = null;

    // --- Core Data Management Functions ---

    // Gets the main users data from local storage
    function getUsers() {
        return JSON.parse(localStorage.getItem("users") || "{}");
    }

    // Saves the main users data to local storage
    function saveUsers(users) {
        localStorage.setItem("users", JSON.stringify(users));
    }

    // Gets the student codes registry from local storage
    function getStudentCodesRegistry() {
        return JSON.parse(localStorage.getItem("student_codes_registry") || "{}");
    }

    // Saves the student codes registry to local storage
    function saveStudentCodesRegistry(registry) {
        localStorage.setItem("student_codes_registry", JSON.stringify(registry));
    }

    // Helper to get the current day of the week (0-Sunday, 1-Monday, ..., 6-Saturday)
    function getDayOfWeek(dateString) {
        const dateObj = new Date(dateString + 'T00:00:00'); // Add 'T00:00:00' for consistent local time interpretation
        return dateObj.getDay();
    }

    // --- Authentication Functions ---
    // Simple hashing function (for demo purposes only, not secure)
    function hashPassword(password) {
        return btoa(password); // Base64 encoding as a very basic "hash"
    }

    // Helper to display messages on the login/register page
    function showAuthMessage(type, message) {
        const authMessageDiv = document.getElementById("authMessage");
        authMessageDiv.textContent = message;
        authMessageDiv.className = `info-message ${type}-message`; // info-message or warning-message or error-message
        authMessageDiv.style.display = "block";
        setTimeout(() => { authMessageDiv.style.display = "none"; }, 5000); // Hide after 5 seconds
    }

    async function handleLogin(event) {
        event.preventDefault(); // Prevent form submission and page reload

        const username = document.getElementById("loginUsername").value.trim();
        const password = document.getElementById("loginPassword").value;
        const hashedPassword = hashPassword(password);

        const users = getUsers();

        if (users[username] && users[username].password === hashedPassword) {
            currentLoggedInUser = { 
                username: username, 
                role: users[username].role,
                pfpUrl: users[username].pfpUrl || defaultPfp, // Load PFP or use default
                linkedStudent: users[username].linkedStudent || null // Load linked student or null
            };
            sessionStorage.setItem("loggedInUser", JSON.stringify(currentLoggedInUser)); // Store user object in session
            updateLoggedInStatus();
            showMessage("Login Successful", `Welcome, ${username}!`, () => {
                checkUserRoleAndDisplayContent(); // Show appropriate content after message dismisses
            });
        } else {
            showAuthMessage("error", "Invalid username or password.");
        }
        document.getElementById("loginPassword").value = ""; // Clear password field
    }

    async function handleRegister(event) {
        event.preventDefault(); // Prevent form submission and page reload

        const username = document.getElementById("registerUsername").value.trim();
        const password = document.getElementById("registerPassword").value;
        const hashedPassword = hashPassword(password);

        if (username === "" || password === "") {
            showAuthMessage("error", "Username and password cannot be empty.");
            return;
        }

        let users = getUsers();
        if (users[username]) {
            showAuthMessage("warning", "Username already exists. Please choose a different one.");
        } else {
            // New accounts default to 'parent' role and default PFP
            users[username] = { password: hashedPassword, role: 'parent', pfpUrl: defaultPfp, linkedStudent: null };
            saveUsers(users);
            showAuthMessage("info", "Account created! Please log in.");
            document.getElementById("registerUsername").value = "";
            document.getElementById("registerPassword").value = "";
            showLoginForm(); // Go back to login after registration
        }
    }

    function logout() {
        sessionStorage.removeItem("loggedInUser");
        currentLoggedInUser = null;
        updateLoggedInStatus();
        showMessage("Logged Out", "You have been logged out.", () => {
            showLoginPage(); // Go back to login page
        });
        toggleMenu(); // Ensure menu is closed on logout
    }

    function updateLoggedInStatus() {
        const statusDiv = document.getElementById("loggedInStatus");
        if (currentLoggedInUser) {
            statusDiv.textContent = `Logged in as: ${currentLoggedInUser.username} (${currentLoggedInUser.role})`;
        } else {
            statusDiv.textContent = "";
        }
    }

    // --- Page/Section Visibility Control ---
    function checkUserRoleAndDisplayContent() {
        // Hide all main content areas first
        document.getElementById("loginPage").classList.add("hidden-page");
        document.getElementById("rankingPage").classList.add("hidden-page");
        document.getElementById("mainContent").classList.add("hidden-page");
        document.getElementById("parentView").classList.add("hidden-page");
        document.getElementById("accountsPage").classList.add("hidden-page"); // Hide accounts page too

        if (currentLoggedInUser && currentLoggedInUser.role === 'teacher') {
            document.getElementById("mainContent").classList.remove("hidden-page");
            updateTeacherUI(true); // Show teacher-specific UI elements
            // Load default students for the main content view if logged in
            initializeCurrentStudentsData(defaultStudents);
            updateTable(); 
            updateLessonTabs(); // Load lessons for the teacher
        } else if (currentLoggedInUser && currentLoggedInUser.role === 'parent') {
            document.getElementById("parentView").classList.remove("hidden-page");
            updateTeacherUI(false); // Hide teacher-specific UI elements
            renderParentView(); // Render the parent-specific content
        } else {
            // No user logged in or unknown role, show login page
            document.getElementById("loginPage").classList.remove("hidden-page");
            showLoginForm(); // Ensure login form is visible
            updateTeacherUI(false); // Hide teacher-specific UI
        }
    }

    // Function to show/hide teacher-specific UI elements
    function updateTeacherUI(isTeacher) {
        // Elements in lessonForm
        document.getElementById('lessonDate').style.display = isTeacher ? '' : 'none';
        document.querySelector('#lessonForm button[type="submit"]').style.display = isTeacher ? '' : 'none';
        
        // Menu buttons
        document.getElementById('menuTuesdayClass').style.display = isTeacher ? 'block' : 'none';
        document.getElementById('menuSaturdayClass').style.display = isTeacher ? 'block' : 'none';
        document.getElementById('menuAddStudent').style.display = isTeacher ? 'block' : 'none';
        document.getElementById('menuRanking').style.display = isTeacher ? 'block' : 'none';
        document.getElementById('menuAccounts').style.display = currentLoggedInUser ? 'block' : 'none'; // Accounts button visible if logged in
        
        // Global update panel and student status panel
        document.getElementById('globalUpdateContainer').style.display = isTeacher ? 'flex' : 'none';
        document.getElementById('clearSaves').style.display = isTeacher ? 'block' : 'none';
        
        // Ensure student table and lesson tabs are cleared/reset if switching from teacher to parent view
        if (!isTeacher) {
            document.querySelector("#pointsTable tbody").innerHTML = "";
            document.getElementById("lessonTabs").innerHTML = "";
            document.getElementById("studentStatusPanel").innerHTML = '<h3>Student Status</h3>'; // Reset student status panel
        }
    }

    function showLoginPage() {
        document.getElementById("mainContent").classList.add("hidden-page");
        document.getElementById("rankingPage").classList.add("hidden-page");
        document.getElementById("parentView").classList.add("hidden-page");
        document.getElementById("accountsPage").classList.add("hidden-page"); // Ensure accounts page is hidden
        document.getElementById("loginPage").classList.remove("hidden-page");
        showLoginForm(); // Default to login form when showing login page
    }

    function showLoginForm() {
        document.getElementById("registerForm").classList.remove("show");
        document.getElementById("loginForm").classList.add("show");
        document.getElementById("loginUsername").focus();
    }

    function showRegisterForm() {
        document.getElementById("loginForm").classList.remove("show");
        document.getElementById("registerForm").classList.add("show");
        document.getElementById("registerUsername").focus();
    }

    // Initialize currentStudentsData based on a provided student list
    function initializeCurrentStudentsData(studentNames) {
        currentStudentsData = studentNames.map(name => ({ name: name, isAbsent: false, isNew: false, studentCode: null }));
    }

    // Updates the main points table based on currentStudentsData
    function updateTable() {
      const tbody = document.querySelector("#pointsTable tbody");
      tbody.innerHTML = "";
      
      currentStudentsData.forEach(studentData => {
        const studentName = studentData.name;
        const tr = document.createElement("tr");
        tr.dataset.studentName = studentName; // Add data attribute for easy lookup
        
        // Apply absent class if student is marked absent
        if (studentData.isAbsent) {
            tr.classList.add('absent-row');
        }

        // Student Name cell with hover and click event for report.
        const nameTd = document.createElement("td");
        
        // If it's a new student (name is empty), show an input field
        if (studentData.isNew) {
            const nameInput = document.createElement("input");
            nameInput.type = "text";
            nameInput.className = "custom-text";
            nameInput.placeholder = "Enter Name";
            nameInput.value = studentName; // In case of initial empty string
            nameInput.onblur = function() { saveNewStudentName(nameInput, tr); };
            nameInput.onkeydown = function(event) {
                if (event.key === 'Enter') {
                    event.preventDefault(); // Prevent form submission
                    saveNewStudentName(nameInput, tr);
                }
            };
            nameTd.appendChild(nameInput);
            // Focus the input automatically for new rows
            setTimeout(() => nameInput.focus(), 0); 
        } else {
            nameTd.textContent = studentName;
            nameTd.addEventListener("click", function() {
              openReport(this);
            });
        }
        tr.appendChild(nameTd);
        
        // Create cells for scoring columns (indices 0 to 5)
        defaultPointsMapping.forEach((defaultVal, index) => {
          const td = document.createElement("td");
          const cellContainer = document.createElement("div");
          cellContainer.className = "cell-container";
          
          if (index === 4) { // NUMBER ACTIVITY column
            const horizontalContainer = document.createElement("div");
            horizontalContainer.className = "numact-cell";
            
            // Left: free text input.
            const textInput = document.createElement("input");
            textInput.type = "text";
            textInput.className = "numact-text custom-text";
            textInput.placeholder = "Text";
            textInput.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            horizontalContainer.appendChild(textInput);
            
            // Right: vertical container for numeric controls.
            const numericContainer = document.createElement("div");
            numericContainer.className = "numact-number-container";
            
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.classList.add("custom-checkbox");
            checkbox.dataset.points = defaultVal;
            checkbox.dataset.index = index;
            checkbox.onchange = function() { recalcRow(this.closest("tr")); };
            checkbox.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            numericContainer.appendChild(checkbox);
            
            const customizer = document.createElement("div");
            customizer.className = "cell-customizer";
            
            const minusBtn = document.createElement("button");
            minusBtn.type = "button";
            minusBtn.textContent = "−";
            minusBtn.onclick = function() { decrementCell(this); };
            minusBtn.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            
            const cellValueInput = document.createElement("input");
            cellValueInput.type = "number";
            cellValueInput.className = "cell-value-input custom-input";
            cellValueInput.value = defaultVal;
            cellValueInput.onchange = function() {
              const newVal = parseInt(this.value, 10);
              checkbox.dataset.points = newVal;
              recalcAll();
            };
            cellValueInput.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            
            const plusBtn = document.createElement("button");
            plusBtn.type = "button";
            plusBtn.textContent = "+";
            plusBtn.onclick = function() { incrementCell(this); };
            plusBtn.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            
            customizer.appendChild(minusBtn);
            customizer.appendChild(cellValueInput);
            customizer.appendChild(plusBtn);
            numericContainer.appendChild(customizer);
            horizontalContainer.appendChild(numericContainer);
            cellContainer.appendChild(horizontalContainer);
          } else {
            // For other columns: standard layout.
            const checkbox = document.createElement("input");
            checkbox.type = "checkbox";
            checkbox.classList.add("custom-checkbox");
            checkbox.dataset.points = defaultVal;
            checkbox.dataset.index = index;
            checkbox.onchange = function() { recalcRow(this.closest("tr")); };
            checkbox.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            cellContainer.appendChild(checkbox);
            
            const customizer = document.createElement("div");
            customizer.className = "cell-customizer";
            
            const minusBtn = document.createElement("button");
            minusBtn.type = "button";
            minusBtn.textContent = "−";
            minusBtn.onclick = function() { decrementCell(this); };
            minusBtn.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            
            const cellValueInput = document.createElement("input");
            cellValueInput.type = "number";
            cellValueInput.className = "cell-value-input custom-input";
            cellValueInput.value = defaultVal;
            cellValueInput.onchange = function() {
              const newVal = parseInt(this.value, 10);
              checkbox.dataset.points = newVal;
              recalcAll();
            };
            cellValueInput.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            
            const plusBtn = document.createElement("button");
            plusBtn.type = "button";
            plusBtn.textContent = "+";
            plusBtn.onclick = function() { incrementCell(this); };
            plusBtn.disabled = studentData.isAbsent || studentData.isNew; // Disable if absent or new
            
            customizer.appendChild(minusBtn);
            customizer.appendChild(cellValueInput);
            customizer.appendChild(plusBtn);
            cellContainer.appendChild(customizer);
          }
          td.appendChild(cellContainer);
          tr.appendChild(td);
        });
        
        // Final Score cell.
        const scoreTd = document.createElement("td");
        scoreTd.className = "final-score";
        scoreTd.textContent = studentData.isAbsent ? "0" : "0"; // Set to 0 if absent initially
        tr.appendChild(scoreTd);
        
        tbody.appendChild(tr);
      });
      updateStudentStatusPanel(); // Also update the new status panel
    }
    
    // --- Student Code Generation & Management ---

    // Generates a random alphanumeric code of a specified length
    function generateRandomCode(length = 8) {
        const characters = 'ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
        let result = '';
        const charactersLength = characters.length;
        for (let i = 0; i < length; i++) {
            result += characters.charAt(Math.floor(Math.random() * charactersLength));
        }
        return result;
    }

    // Generates a unique student code and ensures it's not already in use
    function generateUniqueStudentCode(studentName, teacherUsername) {
        let registry = getStudentCodesRegistry();
        let code;
        let isUnique = false;
        while (!isUnique) {
            code = generateRandomCode();
            if (!registry[code]) { // Check if code is unique
                isUnique = true;
            }
        }
        // Add to registry
        registry[code] = { studentName: studentName, teacherUsername: teacherUsername };
        saveStudentCodesRegistry(registry);
        return code;
    }

    // Function to handle saving a new student's name
    function saveNewStudentName(nameInput, tr) {
        const newName = nameInput.value.trim();
        const oldName = tr.dataset.studentName; 

        if (newName === "") {
            showMessage("Error", "Student name cannot be empty. Row will be removed.");
            // Remove the row from currentStudentsData and the table
            currentStudentsData = currentStudentsData.filter(s => s.name !== oldName);
            updateTable(); // Re-render the table
            return;
        }

        // Check for duplicate names (excluding the student being renamed if it's the same temporary name)
        if (currentStudentsData.some(s => s.name === newName && s.name !== oldName && !s.isNew)) {
            showMessage("Error", `A student named "${newName}" already exists. Please choose a unique name.`);
            nameInput.value = oldName; 
            return;
        }

        // Find the student in currentStudentsData and update their name and remove isNew flag
        const studentIndex = currentStudentsData.findIndex(s => s.name === oldName);
        if (studentIndex !== -1) {
            currentStudentsData[studentIndex].name = newName;
            
            // If it's a brand new student (no code yet), generate one
            if (!currentStudentsData[studentIndex].studentCode) {
                const newCode = generateUniqueStudentCode(newName, currentLoggedInUser.username);
                currentStudentsData[studentIndex].studentCode = newCode;
            } else {
                // If student has a code, update the registry with the new name
                let registry = getStudentCodesRegistry();
                if (registry[currentStudentsData[studentIndex].studentCode]) {
                    registry[currentStudentsData[studentIndex].studentCode].studentName = newName;
                    saveStudentCodesRegistry(registry);
                }
            }

            delete currentStudentsData[studentIndex].isNew; // Remove the temporary flag
        } else {
            console.error("Could not find new student to save name for:", oldName);
            return;
        }

        // Update the tr's data-student-name attribute and replace input with text
        tr.dataset.studentName = newName;
        const nameTd = nameInput.closest('td');
        nameTd.textContent = newName;
        nameTd.addEventListener("click", function() { openReport(this); });

        // Re-enable controls in the row
        const inputs = tr.querySelectorAll('input');
        const buttons = tr.querySelectorAll('button');
        inputs.forEach(input => input.disabled = false);
        buttons.forEach(button => button.disabled = false);

        // Update student status panel after name change
        updateStudentStatusPanel();
        recalcRow(tr); // Recalculate score for the newly named student
    }

    // Function to add a new row for a student with an editable name field
    function addNewStudentRow() {
        if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
            showMessage("Access Denied", "Only teacher accounts can add new students.");
            toggleMenu();
            return;
        }
        // Generate a temporary unique name for the new student
        const tempName = `NEW_STUDENT_${Date.now()}`; // Use a temp name until confirmed
        currentStudentsData.push({ name: tempName, isAbsent: false, isNew: true, studentCode: null });
        updateTable(); // Re-render to show the new row with input
        showMessage("Add Student", "A new row has been added. Please enter the student's name.");
        toggleMenu(); // Hide menu after selection
    }
    
    // Updates the Student Status Panel
    function updateStudentStatusPanel() {
        const panel = document.getElementById('studentStatusPanel');
        panel.innerHTML = '<h3>Student Status</h3>'; // Reset title

        currentStudentsData.forEach(student => {
            // Skip temporary new students in the status panel until named
            if (student.isNew) return;

            const itemDiv = document.createElement('div');
            itemDiv.className = 'student-status-item';

            const studentNameSpan = document.createElement('span');
            studentNameSpan.textContent = student.name;
            itemDiv.appendChild(studentNameSpan);

            const absentButton = document.createElement('button');
            absentButton.textContent = student.isAbsent ? 'Present' : 'Absent';
            absentButton.classList.toggle('absent', student.isAbsent); // Add 'absent' class if student is absent
            absentButton.onclick = () => toggleAbsent(student.name); // Call toggle function

            itemDiv.appendChild(absentButton);
            panel.appendChild(itemDiv);
        });
    }

    // Toggles the absent status for a student
    function toggleAbsent(studentName) {
        const studentIndex = currentStudentsData.findIndex(s => s.name === studentName);
        if (studentIndex === -1) return;

        currentStudentsData[studentIndex].isAbsent = !currentStudentsData[studentIndex].isAbsent;
        
        const tr = document.querySelector(`tr[data-student-name="${studentName}"]`);
        if (tr) {
            tr.classList.toggle('absent-row', currentStudentsData[studentIndex].isAbsent);
            
            // Enable/Disable inputs and checkboxes in the row
            const inputs = tr.querySelectorAll('input:not([type="checkbox"])');
            const checkboxes = tr.querySelectorAll('input[type="checkbox"]');
            const buttons = tr.querySelectorAll('button');

            inputs.forEach(input => input.disabled = currentStudentsData[studentIndex].isAbsent);
            checkboxes.forEach(chk => chk.disabled = currentStudentsData[studentIndex].isAbsent);
            buttons.forEach(button => button.disabled = currentStudentsData[studentIndex].isAbsent);

            // If marking absent, uncheck all and set score to 0
            if (currentStudentsData[studentIndex].isAbsent) {
                checkboxes.forEach(chk => chk.checked = false); // Uncheck all
                updateFinalScoreCell(tr, 0); // Set final score to 0
            } else {
                recalcRow(tr); // Recalculate if becoming present
            }
        }
        updateStudentStatusPanel(); // Update the button text in the status panel
    }
    
    // Recalculate a row's final score.
    function recalcRow(trOrElement) {
      const tr = (trOrElement.tagName === "TR") ? trOrElement : trOrElement.closest("tr");
      const studentName = tr.dataset.studentName;
      const studentData = currentStudentsData.find(s => s.name === studentName);

      if (studentData && studentData.isAbsent) {
          updateFinalScoreCell(tr, 0); // If absent, score is 0
          return;
      }

      let score = 0;
      const checkboxes = tr.querySelectorAll("input[type='checkbox']");
      checkboxes.forEach(chk => {
        if (chk.checked) {
          score += parseInt(chk.dataset.points, 10);
        }
      });
      updateFinalScoreCell(tr, score);
    }
    
    // Update final score cell.
    function updateFinalScoreCell(tr, score) {
      const scoreTd = tr.querySelector(".final-score");
      scoreTd.textContent = score;
    }
    
    function recalcAll() {
      const rows = document.querySelectorAll("#pointsTable tbody tr");
      rows.forEach(tr => recalcRow(tr));
    }
    
    function incrementCell(button) {
      const container = button.parentElement.parentElement;
      const checkbox = container.querySelector("input[type='checkbox']");
      let currentVal = parseInt(checkbox.dataset.points, 10);
      currentVal++;
      checkbox.dataset.points = currentVal;
      const inputField = container.querySelector("input.cell-value-input");
      if (inputField) { inputField.value = currentVal; }
      recalcAll();
    }
    
    function decrementCell(button) {
      const container = button.parentElement.parentElement;
      const checkbox = container.querySelector("input[type='checkbox']");
      let currentVal = parseInt(checkbox.dataset.points, 10);
      currentVal--;
      checkbox.dataset.points = currentVal;
      const inputField = container.querySelector("input.cell-value-input");
      if (inputField) { inputField.value = currentVal; }
      recalcAll();
    }
    
    // ---- Report Modal Functions ----
    function openReport(nameCell) {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Only teacher accounts can view/edit student reports.");
          return;
      }

      // Get the row of the clicked student name.
      const tr = nameCell.parentElement;
      const studentName = nameCell.textContent;
      const studentData = currentStudentsData.find(s => s.name === studentName);
      
      // Get current lesson date (or "unspecified" if not set)
      let lessonDate = document.getElementById("lessonDate").value;
      if (!lessonDate) {
        lessonDate = "Unspecified";
      }
      
      let reportHtml = `<h2>Report for ${studentName}</h2>`;
      reportHtml += `<p>Lesson Date: ${lessonDate}</p>`;

      // Display student code if available
      if (studentData && studentData.studentCode) {
          reportHtml += `<div class="report-actions">
                            <div class="student-code-display">
                                Student Code: <span id="studentCodeToCopy">${studentData.studentCode}</span> 
                                <button class="copy-button" onclick="copyStudentCode()">Copy Code</button>
                            </div>
                         </div>`;
      } else {
          reportHtml += `<p style="color: grey; margin-top: 10px;">No student code generated yet (save lesson after naming new student).</p>`;
      }


      if (studentData && studentData.isAbsent) {
          reportHtml += `<p style="font-weight: bold; color: #e53935; font-size: 1.2rem;">Absent</p>`;
      } else {
          reportHtml += `<table class="report-table"><thead><tr>
                            <th>Category</th>
                            <th>Status</th>
                            <th>Value</th>
                            <th>Notes</th>
                            </tr></thead><tbody>`;
          // Define the column names for data cells (indices 0 to 5 for our scoring data).
          const columns = ["ARRIVAL", "HOMEWORK", "CLASSWORK", "LISTENING CALCULATION", "NUMBER ACTIVITY", "BEHAVIOUR"];
          
          // Loop through cells 1 to 6 of the row.
          for (let i = 1; i <= 6; i++) {
            const cell = tr.cells[i];
            let status = "", value = "", notes = "";
            if (i === 5) {
              // NUMBER ACTIVITY column: retrieve text, checkbox, and numeric value.
              const textInput = cell.querySelector("input.numact-text") || { value: "" };
              const numericContainer = cell.querySelector("div.numact-number-container");
              const checkbox = numericContainer ? numericContainer.querySelector("input[type='checkbox']") : { checked: false };
              const cellValueInput = numericContainer ? numericContainer.querySelector("input.cell-value-input") : { value: "" };
              status = checkbox.checked ? "Checked" : "Unchecked";
              value = cellValueInput.value;
              notes = textInput.value;
            } else {
              // Other columns: retrieve checkbox and value.
              const checkbox = cell.querySelector("input[type='checkbox']");
              const cellValueInput = cell.querySelector("input.cell-value-input");
              status = checkbox && checkbox.checked ? "Checked" : "Unchecked";
              value = cellValueInput ? cellValueInput.value : "";
              notes = "";
            }
            reportHtml += `<tr>
                              <td>${columns[i-1]}</td>
                              <td>${status}</td>
                              <td>${value}</td>
                            <td>${notes}</td>
                            </tr>`;
          }
          reportHtml += `</tbody></table>`;
      }
      
      // Add edit/delete buttons
      reportHtml += `<div class="report-actions">
                        <button class="edit-btn" onclick="promptRenameStudent('${studentName}')">Change Name</button>
                        <button class="delete-btn" onclick="deleteStudentFromCurrentLesson('${studentName}')">Delete Student</button>
                     </div>`;

      // Insert the report HTML into the modal.
      document.getElementById("reportContent").innerHTML = `<button class="close-btn" onclick="closeReport()">×</button>` + reportHtml;
      
      // Show the modal.
      document.getElementById("reportModal").classList.add("show");
    }
    
    function copyStudentCode() {
        const studentCodeSpan = document.getElementById('studentCodeToCopy');
        if (studentCodeSpan) {
            const range = document.createRange();
            range.selectNode(studentCodeSpan);
            window.getSelection().removeAllRanges();
            window.getSelection().addRange(range);
            try {
                document.execCommand('copy');
                showMessage("Copied!", "Student code copied to clipboard.");
            } catch (err) {
                showMessage("Error", "Failed to copy code. Please copy manually.");
            }
            window.getSelection().removeAllRanges(); // Deselect text
        }
    }

    function closeReport() {
      document.getElementById("reportModal").classList.remove("show");
    }

    // ---- Custom Message Modal Functions (replaces alert) ----
    let messageCallback = null; // Callback for when message modal is closed

    function showMessage(title, message, callback = null) {
      document.getElementById("messageTitle").textContent = title;
      document.getElementById("messageText").textContent = message;
      messageCallback = callback; // Store the callback
      document.getElementById("messageModal").classList.add("show");
    }

    function closeMessage() {
      document.getElementById("messageModal").classList.remove("show");
      if (messageCallback) {
        messageCallback(); // Execute callback if it exists
        messageCallback = null; // Clear the callback
      }
    }

    // ---- Custom Confirmation Modal Functions (replaces confirm) ----
    let confirmResolver = null; // Resolver for the confirmation Promise

    function showConfirm(title, message) {
      return new Promise((resolve) => {
        const modal = document.getElementById("confirmModal");
        const titleEl = document.getElementById("confirmTitle");
        const textEl = document.getElementById("confirmText");
        const buttonsEl = modal.querySelector(".modal-buttons");

        titleEl.textContent = title;
        textEl.textContent = message;

        // Ensure default buttons are present
        buttonsEl.innerHTML = `
            <button class="confirm-yes" id="confirmYes">Yes</button>
            <button class="confirm-no" id="confirmNo">No</button>
        `;

        // Re-attach listeners for the generic confirm buttons
        document.getElementById("confirmYes").onclick = () => {
          modal.classList.remove("show");
          resolve(true);
          confirmResolver = null;
        };
        document.getElementById("confirmNo").onclick = () => {
          modal.classList.remove("show");
          resolve(false);
          confirmResolver = null;
        };

        modal.classList.add("show");
        confirmResolver = resolve;
      });
    }

    // --- Student Edit/Delete Functions (affecting current lesson only) ---
    async function promptRenameStudent(oldName) {
        if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
            showMessage("Access Denied", "Only teacher accounts can rename students.");
            return;
        }
        closeReport(); // Close the report modal first

        const newName = await showConfirmWithInput("Change Student Name", `Enter new name for "${oldName}":`, oldName);

        if (newName === null) { // User cancelled
            showMessage("Cancelled", "Name change cancelled.");
            return;
        }
        const trimmedNewName = newName.trim();
        if (trimmedNewName === "" || trimmedNewName === oldName) {
            showMessage("Invalid Name", "Name cannot be empty or the same as the current name.");
            return;
        }

        if (currentStudentsData.some(s => s.name === trimmedNewName && s.name !== oldName)) {
            showMessage("Error", `A student named "${trimmedNewName}" already exists. Please choose a unique name.`);
            return;
        }

        renameStudentInCurrentLesson(oldName, trimmedNewName);
    }

    function renameStudentInCurrentLesson(oldName, newName) {
        const studentIndex = currentStudentsData.findIndex(s => s.name === oldName);
        if (studentIndex === -1) {
            showMessage("Error", "Student not found in current list.");
            return;
        }

        currentStudentsData[studentIndex].name = newName;
        // Also update the student code registry with the new name
        if (currentStudentsData[studentIndex].studentCode) {
            let registry = getStudentCodesRegistry();
            registry[currentStudentsData[studentIndex].studentCode].studentName = newName;
            saveStudentCodesRegistry(registry);
        }

        updateTable(); // Re-render table with new name
        updateStudentStatusPanel(); // Update status panel with new name
        showMessage("Success", `Student "${oldName}" renamed to "${newName}".`);
    }

    async function deleteStudentFromCurrentLesson(studentName) {
        if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
            showMessage("Access Denied", "Only teacher accounts can delete students from the lesson.");
            return;
        }
        closeReport(); // Close the report modal first

        const confirmed = await showConfirm("Confirm Deletion", `Are you sure you want to delete "${studentName}" from THIS LESSON? This cannot be undone for the current view.`);
        
        if (confirmed) {
            const studentToDelete = currentStudentsData.find(s => s.name === studentName);
            if (studentToDelete && studentToDelete.studentCode) {
                let registry = getStudentCodesRegistry();
                delete registry[studentToDelete.studentCode]; // Remove from registry
                saveStudentCodesRegistry(registry);
            }
            currentStudentsData = currentStudentsData.filter(s => s.name !== studentName);
            updateTable(); // Re-render table without the deleted student
            updateStudentStatusPanel(); // Update status panel
            showMessage("Deleted!", `Student "${studentName}" removed from the current lesson.`);
        } else {
            showMessage("Cancelled", "Student deletion cancelled.");
        }
    }

    // Custom Confirmation Modal with Input (for rename)
    let confirmInputResolver = null;
    function showConfirmWithInput(title, message, defaultValue = '') {
        return new Promise((resolve) => {
            const modal = document.getElementById("confirmModal");
            const titleEl = document.getElementById("confirmTitle");
            const textEl = document.getElementById("confirmText");
            const buttonsEl = modal.querySelector(".modal-buttons");

            titleEl.textContent = title;
            textEl.textContent = message;

            // Clear existing buttons and add input + new buttons
            buttonsEl.innerHTML = `
                <input type="text" id="confirmInput" class="custom-text" value="${defaultValue}" style="margin-bottom: 15px; width: 80%; text-align: center;" />
                <button class="confirm-yes" id="confirmInputYes">OK</button>
                <button class="confirm-no" id="confirmInputNo">Cancel</button>
            `;
            const confirmInput = document.getElementById("confirmInput");
            confirmInput.focus();
            confirmInput.select(); // Select the default text

            confirmInput.onkeydown = (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    document.getElementById("confirmInputYes").click(); // Trigger click on Enter
                }
            };

            document.getElementById("confirmInputYes").onclick = () => {
                modal.classList.remove("show");
                resolve(confirmInput.value);
                resetConfirmModalButtons();
            };
            document.getElementById("confirmInputNo").onclick = () => {
                modal.classList.remove("show");
                resolve(null); // Resolve with null for cancellation
                resetConfirmModalButtons();
            };

            modal.classList.add("show");
            confirmInputResolver = resolve;
        });
    }

    function resetConfirmModalButtons() {
        // Restore default buttons for future uses of showConfirm
        const buttonsEl = document.getElementById("confirmModal").querySelector(".modal-buttons");
        buttonsEl.innerHTML = `
            <button class="confirm-yes" id="confirmYes">Yes</button>
            <button class="confirm-no" id="confirmNo">No</button>
        `;
        // Re-attach original event listeners from global scope (they are attached once)
        // For simplicity, just ensure the standard buttons are back. The showConfirm function re-establishes their handlers.
    }

    // Custom Confirmation Modal with Multiple Inputs (for change password)
    let multiInputConfirmResolver = null;
    function showConfirmWithMultipleInputs(title, message, inputsConfig) {
        return new Promise((resolve) => {
            const modal = document.getElementById("multiInputConfirmModal");
            const titleEl = document.getElementById("multiInputConfirmTitle");
            const textEl = document.getElementById("multiInputConfirmText");
            const fieldsDiv = document.getElementById("multiInputConfirmFields");

            titleEl.textContent = title;
            textEl.textContent = message;
            fieldsDiv.innerHTML = ''; // Clear previous inputs

            const inputElements = {};
            inputsConfig.forEach((config, index) => {
                const groupDiv = document.createElement('div');
                groupDiv.className = 'form-group';

                const label = document.createElement('label');
                label.htmlFor = `multiInput-${index}`;
                label.textContent = config.label;
                groupDiv.appendChild(label);

                const input = document.createElement('input');
                input.type = config.type;
                input.id = `multiInput-${index}`;
                input.className = 'custom-input';
                input.placeholder = config.placeholder || '';
                input.required = config.required || false;
                groupDiv.appendChild(input);

                fieldsDiv.appendChild(groupDiv);
                inputElements[config.name] = input; // Store input element reference by name
            });

            // Focus the first input field
            setTimeout(() => {
                if (inputsConfig.length > 0) {
                    inputElements[inputsConfig[0].name].focus();
                }
            }, 0);

            document.getElementById("multiInputConfirmOk").onclick = () => {
                const values = {};
                let allInputsValid = true;
                inputsConfig.forEach(config => {
                    const input = inputElements[config.name];
                    if (input.required && input.value.trim() === '') {
                        allInputsValid = false;
                        input.style.borderColor = 'red'; // Simple visual cue
                    } else {
                        input.style.borderColor = ''; // Reset border
                    }
                    values[config.name] = input.value;
                });

                if (allInputsValid) {
                    modal.classList.remove("show");
                    resolve(values);
                    multiInputConfirmResolver = null;
                } else {
                    showMessage("Error", "Please fill in all required fields.");
                }
            };
            document.getElementById("multiInputConfirmCancel").onclick = () => {
                modal.classList.remove("show");
                resolve(null); // Resolve with null for cancellation
                multiInputConfirmResolver = null;
            };

            modal.classList.add("show");
            multiInputConfirmResolver = resolve;
        });
    }

    // --- Account Management Functions (Change Password / Delete Account / PFP) ---
    async function showChangePasswordModal() {
        if (!currentLoggedInUser) {
            showMessage("Error", "You must be logged in to change your password.");
            closeAccountsPage(); // Go back if somehow reached
            return;
        }

        const inputs = [
            { label: "Current Password:", type: "password", name: "currentPassword", required: true },
            { label: "New Password:", type: "password", name: "newPassword", required: true },
            { label: "Confirm New Password:", type: "password", name: "confirmNewPassword", required: true }
        ];

        const result = await showConfirmWithMultipleInputs("Change Password", "Please enter your current and new password:", inputs);

        if (result === null) { // User cancelled
            showMessage("Cancelled", "Password change cancelled.");
            return;
        }

        const { currentPassword, newPassword, confirmNewPassword } = result;

        if (newPassword !== confirmNewPassword) {
            showMessage("Error", "New password and confirmation do not match.");
            return;
        }
        if (newPassword.length < 1) { // Simple validation: not empty
            showMessage("Error", "New password cannot be empty.");
            return;
        }

        handleChangePassword(currentPassword, newPassword);
    }

    function handleChangePassword(currentPassword, newPassword) {
        if (!currentLoggedInUser) return;

        const users = getUsers();
        const username = currentLoggedInUser.username;
        const storedPasswordHash = users[username].password;
        const currentPasswordHash = hashPassword(currentPassword);

        if (storedPasswordHash !== currentPasswordHash) {
            showMessage("Error", "Current password is incorrect.");
            return;
        }

        users[username].password = hashPassword(newPassword);
        saveUsers(users);
        showMessage("Success", "Your password has been changed. Please log in with your new password.", () => {
            logout(); // Log out after password change
        });
    }

    async function showDeleteAccountModal() {
        if (!currentLoggedInUser) {
            showMessage("Error", "You must be logged in to delete your account.");
            closeAccountsPage(); // Go back if somehow reached
            return;
        }

        const username = currentLoggedInUser.username;
        const inputs = [
            { label: `Confirm password for ${username}:`, type: "password", name: "password", required: true }
        ];

        const result = await showConfirmWithMultipleInputs("Delete Account", "This action is permanent and cannot be undone. All your saved data will be deleted. Please enter your password to confirm:", inputs);

        if (result === null) { // User cancelled
            showMessage("Cancelled", "Account deletion cancelled.");
            return;
        }

        handleDeleteAccount(result.password);
    }

    function handleDeleteAccount(passwordConfirmation) {
        if (!currentLoggedInUser) return;

        const users = getUsers();
        const username = currentLoggedInUser.username;
        const storedPasswordHash = users[username].password;
        const confirmationPasswordHash = hashPassword(passwordConfirmation);

        if (storedPasswordHash !== confirmationPasswordHash) {
            showMessage("Error", "Password incorrect. Account not deleted.");
            return;
        }

        delete users[username]; // Remove user from users list
        localStorage.removeItem(`lessons_${username}`); // Remove associated lessons
        saveUsers(users);

        showMessage("Account Deleted", "Your account and all associated data have been permanently deleted.", () => {
            logout(); // Log out after deletion
        });
    }

    function saveProfilePicture() {
        if (!currentLoggedInUser) {
            showMessage("Error", "You must be logged in to change your profile picture.");
            return;
        }

        const pfpUrlInput = document.getElementById("pfpUrlInput").value.trim();
        let newPfpUrl = pfpUrlInput;

        // Basic validation for URL (can be more robust)
        if (pfpUrlInput && !(pfpUrlInput.startsWith('http://') || pfpUrlInput.startsWith('https://'))) {
            showMessage("Invalid URL", "Please enter a valid URL starting with http:// or https://, or leave blank for default.");
            return;
        }
        
        if (pfpUrlInput === "") { // If input is empty, revert to default
            newPfpUrl = defaultPfp;
        }

        // Update currentLoggedInUser and localStorage
        let users = getUsers();
        users[currentLoggedInUser.username].pfpUrl = newPfpUrl;
        saveUsers(users);
        
        currentLoggedInUser.pfpUrl = newPfpUrl; // Update session data
        sessionStorage.setItem("loggedInUser", JSON.stringify(currentLoggedInUser));

        updateAccountsPageUI(); // Update the image displayed on the page
        showMessage("Success", "Profile picture updated!");
    }
    
    // ---- Lesson Saving System ----
    function getLessonDataForSave() { 
      const data = [];
      const rows = document.querySelectorAll("#pointsTable tbody tr");
      rows.forEach(tr => {
        const studentName = tr.cells[0].textContent;
        // Find the student in currentStudentsData to get the accurate isAbsent status
        const studentRecord = currentStudentsData.find(s => s.name === studentName);
        const isAbsent = studentRecord ? studentRecord.isAbsent : false;
        const studentCode = studentRecord ? studentRecord.studentCode : null; // Get student code

        const rowData = { student: studentName, cells: [], isAbsent: isAbsent, studentCode: studentCode }; 
        
        // Save data from cells 1 to 6.
        for (let col = 1; col <= 6; col++) {
          const cell = tr.cells[col];
          let cellData = {};
          if (col === 5) {  // NUMBER ACTIVITY column
            const textInput = cell.querySelector("input.numact-text");
            const numericContainer = cell.querySelector("div.numact-number-container");
            const checkbox = numericContainer ? numericContainer.querySelector("input[type='checkbox']") : null;
            const valueInput = numericContainer ? numericContainer.querySelector("input.cell-value-input") : null;
            cellData = {
              text: textInput ? textInput.value : '', // Ensure value even if input not found (e.g., new student row)
              checkbox: checkbox ? checkbox.checked : false,
              value: valueInput ? parseInt(valueInput.value, 10) : defaultPointsMapping[col-1]
            };
          } else {
            const checkbox = cell.querySelector("input[type='checkbox']");
            const valueInput = cell.querySelector("input.cell-value-input");
            cellData = {
              checkbox: checkbox ? checkbox.checked : false,
              value: valueInput ? parseInt(valueInput.value, 10) : defaultPointsMapping[col-1]
            };
          }
          rowData.cells.push(cellData);
        }
        // Calculate the current row's final score directly from the table
        const scoreTd = tr.querySelector(".final-score");
        rowData.finalScore = parseInt(scoreTd.textContent, 10); 
        data.push(rowData);
      });
      // Store the names of the students currently in the table, to reconstruct on load
      const studentNamesOnly = currentStudentsData.filter(s => !s.isNew).map(s => s.name); 
      return { students: studentNamesOnly, rows: data }; 
    }
    
    async function saveLesson(event) {
      event.preventDefault();
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Only teacher accounts can save lessons.");
          return;
      }

      const lessonDate = document.getElementById("lessonDate").value;
      if (!lessonDate) {
        showMessage("Error", "Please select a lesson date.");
        return;
      }
      // Ensure no new students are in "isNew" state when saving
      if (currentStudentsData.some(s => s.isNew)) {
          showMessage("Error", "Please enter names for all new students before saving the lesson.");
          return;
      }

      const lessonData = getLessonDataForSave(); 
      const lesson = { date: lessonDate, studentList: lessonData.students, rows: lessonData.rows };

      let userLessons = JSON.parse(localStorage.getItem(`lessons_${currentLoggedInUser.username}`) || "[]");
      const existingIndex = userLessons.findIndex(l => l.date === lessonDate);
      if (existingIndex >= 0) {
        userLessons[existingIndex] = lesson;
      } else {
        userLessons.push(lesson);
      }
      localStorage.setItem(`lessons_${currentLoggedInUser.username}`, JSON.stringify(userLessons));
      updateLessonTabs();
      showMessage("Success", "Lesson saved!");
      toggleMenu(); // Hide menu after saving
    }
    
    document.getElementById("lessonForm").addEventListener("submit", saveLesson);
    
    // When the lesson date changes, load the lesson if it exists; otherwise update based on day of week.
    document.getElementById("lessonDate").addEventListener("change", function() {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Granted", "Please log in as a teacher to load/manage lessons.");
          document.getElementById("lessonDate").value = "";
          return;
      }

      const lessonDate = this.value; 
      if (!lessonDate) {
        // If date is cleared, revert to default students
        initializeCurrentStudentsData(defaultStudents);
        updateTable();
        recalcAll();
        updateLessonTabs(); // Clear active tab
        return;
      }

      let userLessons = JSON.parse(localStorage.getItem(`lessons_${currentLoggedInUser.username}`) || "[]");
      const existingLesson = userLessons.find(l => l.date === lessonDate);

      if (existingLesson) {
        loadLesson(existingLesson); // Load the found lesson object
      } else {
        // No saved lesson for this date, so determine students based on day of week
        const dayOfWeek = getDayOfWeek(lessonDate); 

        let newStudentNames = [...defaultStudents];
        let message = "Switched to default student list for this day.";

        if (dayOfWeek === 2) { // Tuesday
          newStudentNames = [...tuesdayStudents];
          message = "Automatically switched to Tuesday student list.";
        } else if (dayOfWeek === 6) { // Saturday
          newStudentNames = [...saturdayStudents];
          message = "Automatically switched to Saturday student list.";
        } 
        
        // When setting a new student list (for an unsaved date), ensure codes are null
        initializeCurrentStudentsData(newStudentNames.map(name => ({ name: name, isAbsent: false, isNew: false, studentCode: null })));
        updateTable(); // Rebuild the table with the determined student list
        recalcAll(); // Recalculate scores for the new table
        updateLessonTabs(); // Update tabs, remove any active tab since it's a new date without save
        showMessage("Student List Updated", message);
      }
    });
    
    function updateLessonTabs() {
      const lessonTabsDiv = document.getElementById("lessonTabs");
      lessonTabsDiv.innerHTML = "";
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') return; // Don't show tabs if not logged in or not teacher

      let userLessons = JSON.parse(localStorage.getItem(`lessons_${currentLoggedInUser.username}`) || "[]");
      // Sort lessons by date in descending order (most recent first)
      userLessons.sort((a, b) => new Date(b.date) - new Date(a.date));

      userLessons.forEach((lesson) => { 
        const tab = document.createElement("div");
        tab.className = "lesson-tab";
        tab.textContent = lesson.date;
        tab.onclick = function() { loadLesson(lesson); }; 
        lessonTabsDiv.appendChild(tab);
      });
      // Set the active tab if a date is currently selected in the input
      const currentSelectedDate = document.getElementById("lessonDate").value;
      if (currentSelectedDate) {
        const tabs = document.getElementsByClassName("lesson-tab");
        Array.from(tabs).forEach(tab => {
          if (tab.textContent === currentSelectedDate) {
            tab.classList.add("active");
          } else {
            tab.classList.remove("active");
          }
        });
      }
    }
    
    // Centralized function to load a lesson state (from localStorage)
    function loadLesson(lesson) {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Please log in as a teacher to load lessons.");
          return;
      }
      if (!lesson || !lesson.date || !lesson.studentList || !lesson.rows) {
        showMessage("Error", "Invalid lesson data provided.");
        return;
      }

      // Re-initialize currentStudentsData from the provided lesson's studentList
      currentStudentsData = lesson.studentList.map(name => {
          const savedStudentData = lesson.rows.find(row => row.student === name);
          return {
              name: name,
              isAbsent: savedStudentData ? savedStudentData.isAbsent : false,
              isNew: false, // Ensure loaded students are not marked as new
              studentCode: savedStudentData ? savedStudentData.studentCode : null // Load student code
          };
      });

      updateTable(); 
      // Set the date input to the loaded lesson's date
      document.getElementById("lessonDate").value = lesson.date;

      // Now populate the specific cell data and apply absent status
      lesson.rows.forEach((rowData) => { 
        const studentRow = document.querySelector(`tr[data-student-name="${rowData.student}"]`);
        
        if(studentRow){ 
          const studentRecord = currentStudentsData.find(s => s.name === rowData.student);
          // Only apply cell data if not absent (absent status will be handled by toggleAbsent below)
          if (!rowData.isAbsent) {
              rowData.cells.forEach((cellData, j) => {
                const cell = studentRow.cells[j+1]; 
                if (j === 4) {  // NUMBER ACTIVITY column
                  const textInput = cell.querySelector("input.numact-text");
                  const numericContainer = cell.querySelector("div.numact-number-container");
                  const checkbox = numericContainer ? numericContainer.querySelector("input[type='checkbox']") : null;
                  const valueInput = numericContainer ? numericContainer.querySelector("input.cell-value-input") : null;
                  if (textInput) textInput.value = cellData.text;
                  if (checkbox) {
                      checkbox.checked = cellData.checkbox;
                      checkbox.dataset.points = cellData.value;
                  }
                  if (valueInput) valueInput.value = cellData.value;
                } else {
                  const checkbox = cell.querySelector("input[type='checkbox']");
                  const valueInput = cell.querySelector("input.cell-value-input");
                  if (checkbox) {
                      checkbox.checked = cellData.checkbox;
                      checkbox.dataset.points = cellData.value;
                  }
                  if (valueInput) valueInput.value = cellData.value;
                }
              });
          }
          // After populating values, apply absent status. This will trigger recalcRow if becoming present.
          if (rowData.isAbsent) {
              toggleAbsent(rowData.student); // This handles setting row class, disabling inputs, and setting score to 0
          } else {
              recalcRow(studentRow); // Recalculate if the student is present
          }
        }
      });
      updateStudentStatusPanel(); 
      updateLessonTabs(); // Update active tab status
    }

    // Function to set Tuesday students (called by manual button click)
    function setTuesday() {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Please log in as a teacher to set class lists.");
          toggleMenu();
          return;
      }
      initializeCurrentStudentsData(tuesdayStudents); 
      updateTable(); 
      recalcAll(); 
      document.getElementById("lessonDate").value = ""; 
      updateLessonTabs(); 
      showMessage("Student List Updated", "Manually switched to Tuesday student list.");
      toggleMenu(); // Hide menu after selection
    }

    // Function to set Saturday students (called by manual button click)
    function setSaturday() {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Please log in as a teacher to set class lists.");
          toggleMenu();
          return;
      }
      initializeCurrentStudentsData(saturdayStudents); 
      updateTable(); 
      recalcAll(); 
      document.getElementById("lessonDate").value = ""; 
      updateLessonTabs(); 
      showMessage("Student List Updated", "Manually switched to Saturday student list.");
      toggleMenu(); // Hide menu after selection
    }
    
    async function clearAllSaves() {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Please log in as a teacher to clear saves.");
          toggleMenu();
          return;
      }
      const confirmed = await showConfirm("Confirm Deletion", "Are you sure you want to clear ALL your saved lessons? This action cannot be undone.");
      if (confirmed) {
        localStorage.removeItem(`lessons_${currentLoggedInUser.username}`);
        // Optionally, remove students linked to this teacher from registry, but only if no other teacher uses them
        // For simplicity, we'll assume a teacher 'owns' their student codes for now.
        let registry = getStudentCodesRegistry();
        for (const code in registry) {
            if (registry[code].teacherUsername === currentLoggedInUser.username) {
                delete registry[code];
            }
        }
        saveStudentCodesRegistry(registry);

        updateLessonTabs();
        initializeCurrentStudentsData(defaultStudents); 
        updateTable(); 
        recalcAll(); 
        showMessage("Success", "All saved lessons cleared.");
      } else {
        showMessage("Cancelled", "Clear all saves action cancelled.");
      }
      toggleMenu(); // Hide menu if visible
    }

    // Function to apply global updates to all checkboxes in a specific column
    function applyGlobalUpdate(colIndex) {
      if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
          showMessage("Access Denied", "Please log in as a teacher to apply global updates.");
          return;
      }
      const globalValueInput = document.getElementById(`global-col-${colIndex}`);
      const newValue = parseInt(globalValueInput.value, 10);
      if (isNaN(newValue)) {
        showMessage("Invalid Input", "Please enter a valid number for the global update.");
        return;
      }

      const rows = document.querySelectorAll("#pointsTable tbody tr");
      rows.forEach(tr => {
        const studentName = tr.dataset.studentName;
        const studentData = currentStudentsData.find(s => s.name === studentName);
        
        // Skip updating absent or new students
        if (studentData && (studentData.isAbsent || studentData.isNew)) {
            return; 
        }

        const targetCell = tr.cells[colIndex + 1];
        let checkbox = null;
        let valueInput = null;

        if (colIndex === 4) { 
          const numericContainer = targetCell.querySelector("div.numact-number-container");
          if (numericContainer) {
            checkbox = numericContainer.querySelector("input[type='checkbox']");
            valueInput = numericContainer.querySelector("input.cell-value-input");
          }
        } else {
          checkbox = targetCell.querySelector("input[type='checkbox']");
          valueInput = targetCell.querySelector("input.cell-value-input");
        }
        
        if (checkbox && valueInput) {
          checkbox.dataset.points = newValue;
          valueInput.value = newValue;
        }
      });
      recalcAll(); 
      showMessage("Update Applied", `Global update applied to column ${colIndex + 1}.`);
    }

    // --- Menu Toggle Function ---
    function toggleMenu() {
        const menuButtons = document.getElementById('menuButtons');
        if (menuButtons.classList.contains('show')) {
            menuButtons.classList.remove('show');
        } else {
            menuButtons.classList.add('show');
        }
    }

    // --- Ranking Page Functions ---
    function openRankingPage() {
        if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') {
            showMessage("Access Denied", "Please log in as a teacher to view rankings.");
            toggleMenu();
            return;
        }
        document.getElementById("mainContent").classList.add("hidden-page");
        document.getElementById("loginPage").classList.add("hidden-page"); 
        document.getElementById("parentView").classList.add("hidden-page"); 
        document.getElementById("accountsPage").classList.add("hidden-page"); // Hide accounts page
        

        document.getElementById("rankingPage").style.display = "block"; // Use style.display to allow animation
        document.getElementById("rankingPage").classList.remove("hidden-page"); // Remove hidden class to apply fadeIn
        document.getElementById("rankingResults").innerHTML = '<p>Select a class to view rankings.</p>'; // Clear previous results
        toggleMenu(); // Hide menu after opening ranking page
    }

    function closeRankingPage() {
        document.getElementById("rankingPage").classList.add("hidden-page");
        checkUserRoleAndDisplayContent(); // Go back to main content or parent view based on role
    }

    function calculateRanking(classType) {
        if (!currentLoggedInUser || currentLoggedInUser.role !== 'teacher') return []; // Cannot calculate without a teacher user

        let allLessons = JSON.parse(localStorage.getItem(`lessons_${currentLoggedInUser.username}`) || "[]");
        let totalScores = {};

        allLessons.forEach(lesson => {
            const dayOfWeek = getDayOfWeek(lesson.date); // 0=Sun, 1=Mon, ..., 6=Sat

            // Filter lessons by class type
            if ((classType === 'Saturday' && dayOfWeek === 6) ||
                (classType === 'Tuesday' && dayOfWeek === 2)) {
                
                lesson.rows.forEach(studentRow => {
                    // Only count points for students who were present
                    // Use the finalScore from the saved lesson data
                    if (!studentRow.isAbsent && studentRow.finalScore !== undefined) { 
                        const studentName = studentRow.student;
                        const finalScore = studentRow.finalScore;
                        
                        if (totalScores[studentName]) {
                            totalScores[studentName] += finalScore;
                        } else {
                            totalScores[studentName] = finalScore;
                        }
                    }
                });
            }
        });

        // Convert to an array of { student: name, totalPoints: score } objects
        let ranking = Object.keys(totalScores).map(name => ({
            student: name,
            totalPoints: totalScores[name]
        }));

        // Sort by total points in descending order
        ranking.sort((a, b) => b.totalPoints - a.totalPoints);

        return ranking;
    }

    function displayRanking(classType) {
        const rankingResultsDiv = document.getElementById("rankingResults");
        const ranking = calculateRanking(classType);

        let rankingHtml = `<h3>${classType} Class Ranking</h3>`;

        if (ranking.length === 0) {
            rankingHtml += `<p>No data available for ${classType} class rankings yet.</p>`;
        } else {
            rankingHtml += `<table class="ranking-table">
                                <thead>
                                    <tr>
                                        <th>Rank</th>
                                        <th>Student Name</th>
                                        <th>Total Points</th>
                                    </tr>
                                </thead>
                                <tbody>`;
            ranking.forEach((entry, index) => {
                rankingHtml += `<tr>
                                    <td>${index + 1}</td>
                                    <td>${entry.student}</td>
                                    <td>${entry.totalPoints}</td>
                                </tr>`;
            });
            rankingHtml += `</tbody></table>`;
        }
        rankingResultsDiv.innerHTML = rankingHtml;
    }

    // --- Accounts Page Functions ---
    function openAccountsPage() {
        if (!currentLoggedInUser) {
            showMessage("Error", "You must be logged in to access account settings.");
            toggleMenu();
            return;
        }

        // Hide all other pages
        document.getElementById("mainContent").classList.add("hidden-page");
        document.getElementById("loginPage").classList.add("hidden-page"); 
        document.getElementById("parentView").classList.add("hidden-page"); 
        document.getElementById("rankingPage").classList.add("hidden-page"); 

        // Show accounts page
        document.getElementById("accountsPage").style.display = "block";
        document.getElementById("accountsPage").classList.remove("hidden-page");
        
        updateAccountsPageUI(); // Populate user details
        toggleMenu(); // Close the menu
    }

    function updateAccountsPageUI() {
        if (currentLoggedInUser) {
            document.getElementById("accountUsername").textContent = currentLoggedInUser.username;
            document.getElementById("accountRole").textContent = currentLoggedInUser.role;
            document.getElementById("profilePicture").src = currentLoggedInUser.pfpUrl || defaultPfp;
            document.getElementById("pfpUrlInput").value = currentLoggedInUser.pfpUrl === defaultPfp ? '' : currentLoggedInUser.pfpUrl; // Clear input if default PFP
        }
    }

    function closeAccountsPage() {
        document.getElementById("accountsPage").classList.add("hidden-page");
        checkUserRoleAndDisplayContent(); // Go back to main content or parent view
    }

    // --- Parent View Specific Functions ---
    function renderParentView() {
        const parentContentDiv = document.getElementById('parentContent');
        parentContentDiv.innerHTML = ''; // Clear previous content

        if (currentLoggedInUser && currentLoggedInUser.linkedStudent) {
            // Display linked student info
            parentContentDiv.innerHTML = `
                <div class="parent-content-section linked-student-info">
                    <p>Your child is linked to: <strong>${currentLoggedInUser.linkedStudent.name}</strong> (Teacher: ${currentLoggedInUser.linkedStudent.teacher})</p>
                    <button class="secondary-btn" onclick="unlinkStudent()">Unlink Student</button>
                </div>
            `;
        } else if (tempStudentCodeData) {
            // Display confirmation prompt
            parentContentDiv.innerHTML = `
                <div class="parent-content-section confirm-student-prompt">
                    <p>Is this your child: <strong>${tempStudentCodeData.studentName}</strong> (Teacher: ${tempStudentCodeData.teacherUsername})?</p>
                    <div class="form-actions">
                        <button class="confirm-yes" onclick="confirmStudentLink(true)">Yes</button>
                        <button class="confirm-no no-btn" onclick="confirmStudentLink(false)">No</button>
                    </div>
                </div>
            `;
        } else {
            // Display code input form
            parentContentDiv.innerHTML = `
                <div class="parent-content-section">
                    <p>Please enter the code provided by your child's teacher to link to their progress:</p>
                    <div class="form-group">
                        <label for="studentCodeInput">Student Code:</label>
                        <input type="text" id="studentCodeInput" class="custom-input" placeholder="e.g., ABC12345" required />
                    </div>
                    <div class="form-actions">
                        <button type="button" onclick="linkStudentByCode()">Link My Student</button>
                    </div>
                </div>
            `;
        }
    }

    async function linkStudentByCode() {
        const codeInput = document.getElementById('studentCodeInput');
        const code = codeInput.value.trim().toUpperCase(); // Convert to uppercase for consistent lookup

        if (!code) {
            showMessage("Error", "Please enter a student code.");
            return;
        }

        const registry = getStudentCodesRegistry();
        const studentInfo = registry[code];

        if (studentInfo) {
            tempStudentCodeData = { // Store temporarily for confirmation
                code: code,
                studentName: studentInfo.studentName,
                teacherUsername: studentInfo.teacherUsername
            };
            renderParentView(); // Show confirmation prompt
        } else {
            showMessage("Not Found", "No student found with that code. Please check the code and try again.");
            codeInput.value = ''; // Clear input
        }
    }

    function confirmStudentLink(isConfirmed) {
        if (!tempStudentCodeData) return; // Should not happen

        if (isConfirmed) {
            // Link the parent's account to the student
            let users = getUsers();
            if (users[currentLoggedInUser.username]) {
                users[currentLoggedInUser.username].linkedStudent = {
                    name: tempStudentCodeData.studentName,
                    teacher: tempStudentCodeData.teacherUsername
                };
                saveUsers(users);
                currentLoggedInUser.linkedStudent = users[currentLoggedInUser.username].linkedStudent; // Update session data
                sessionStorage.setItem("loggedInUser", JSON.stringify(currentLoggedInUser));
                showMessage("Success", `You are now linked to ${tempStudentCodeData.studentName}.`);
            }
        } else {
            showMessage("Cancelled", "Linking cancelled. You can try another code.");
        }
        tempStudentCodeData = null; // Clear temp data
        renderParentView(); // Re-render to show appropriate state
    }

    function unlinkStudent() {
        if (!currentLoggedInUser || !currentLoggedInUser.linkedStudent) return;

        showConfirm("Unlink Student", `Are you sure you want to unlink from ${currentLoggedInUser.linkedStudent.name}?`).then(confirmed => {
            if (confirmed) {
                let users = getUsers();
                if (users[currentLoggedInUser.username]) {
                    users[currentLoggedInUser.username].linkedStudent = null;
                    saveUsers(users);
                    currentLoggedInUser.linkedStudent = null; // Update session data
                    sessionStorage.setItem("loggedInUser", JSON.stringify(currentLoggedInUser));
                    showMessage("Unlinked", "You have been unlinked from the student.");
                }
            } else {
                showMessage("Cancelled", "Unlinking cancelled.");
            }
            renderParentView(); // Re-render parent view
        });
    }
    
    // Initial setup on page load
    document.addEventListener("DOMContentLoaded", () => {
        // Pre-seed teacher accounts if they don't exist
        let users = getUsers();
        const teacherPasswordHash = hashPassword("P"); // Hashing 'P' once

        if (!users["Viji"]) {
            users["Viji"] = { password: teacherPasswordHash, role: 'teacher', pfpUrl: defaultPfp, linkedStudent: null };
            console.log("Seeding Viji as teacher.");
        } else {
            // Ensure existing teacher accounts have default PFP and linkedStudent property
            if (!users["Viji"].pfpUrl) users["Viji"].pfpUrl = defaultPfp;
            if (!users["Viji"].linkedStudent) users["Viji"].linkedStudent = null;
        }

        if (!users["Rohind"]) {
            users["Rohind"] = { password: teacherPasswordHash, role: 'teacher', pfpUrl: defaultPfp, linkedStudent: null };
            console.log("Seeding Rohind as teacher.");
        } else {
            // Ensure existing teacher accounts have default PFP and linkedStudent property
            if (!users["Rohind"].pfpUrl) users["Rohind"].pfpUrl = defaultPfp;
            if (!users["Rohind"].linkedStudent) users["Rohind"].linkedStudent = null;
        }
        saveUsers(users);

        // Initialize student codes registry if it doesn't exist
        let registry = getStudentCodesRegistry();
        if (Object.keys(registry).length === 0) {
            console.log("Initializing empty student_codes_registry.");
            saveStudentCodesRegistry({}); // Save an empty object
        }

        // Check if user is already logged in from a previous session
        const storedUser = sessionStorage.getItem("loggedInUser");
        if (storedUser) {
            try {
                currentLoggedInUser = JSON.parse(storedUser);
                // Ensure pfpUrl and linkedStudent are present in current session, if not, set default
                if (!currentLoggedInUser.pfpUrl) currentLoggedInUser.pfpUrl = defaultPfp;
                if (!currentLoggedInUser.linkedStudent) currentLoggedInUser.linkedStudent = null;
                sessionStorage.setItem("loggedInUser", JSON.stringify(currentLoggedInUser));

                updateLoggedInStatus();
                checkUserRoleAndDisplayContent();
            } catch (e) {
                console.error("Failed to parse loggedInUser from session storage:", e);
                sessionStorage.removeItem("loggedInUser"); // Clear invalid session
                showLoginPage();
            }
        } else {
            showLoginPage(); // Show login page if no user in session
        }
    });
  </script>
</body>
</html>